define(["require", "exports", "game/product", "game/icons"], function (require, exports, product_1, icons_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.test = exports.Company = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    var distributionTable = undefined;
    function getRandomCompanyType(notThisIds = undefined) {
        if (notThisIds === undefined)
            notThisIds = [];
        if (!distributionTable) {
            distributionTable = [];
            var distCount = 0;
            for (var x = 0; x < product_1.allProducts.length; x++) {
                for (var y = 0; y < product_1.allProducts[x].distribution; y++) {
                    distributionTable.push(product_1.allProducts[x].id);
                }
            }
        }
        var rand = undefined;
        while (rand === undefined || notThisIds.indexOf(rand) > -1) {
            rand = getRandomInt(distributionTable.length);
            rand = distributionTable[rand];
        }
        return rand;
    }
    class Company {
        constructor(notThisIds = undefined) {
            this.buildings = 0;
            this.workers = 0;
            this.hasLicense = false;
            this.type = "Company";
            this.dailyProducedToday = 0;
            this.productid = getRandomCompanyType(notThisIds);
            this.buildings = 0; // getRandomInt(3)+1;
            this.workers = 25 * this.buildings;
            this.hasLicense = (product_1.allProducts[this.productid].distribution <= 8) ? false : true;
        }
        getMaxWorkers() {
            return this.buildings * 25;
        }
        getDailyProduce() {
            var produce = this.workers * product_1.allProducts[this.productid].dailyProduce / 25;
            return Math.round(produce);
        }
        getDailyInput1() {
            var needs = 0;
            var product = product_1.allProducts[this.productid];
            if (product.input1 !== undefined) {
                var p = product_1.allProducts[product.input1];
                needs = this.workers * product.input1Amount / 25;
            }
            return needs;
        }
        getBuildingCoastsAsIcon() {
            var a = this.getBuildingCoasts();
            return a[0] + icons_1.Icons.money + "<br/>" + a[1] + "x" + product_1.allProducts[0].getIcon() + "<br/>" + a[2] + "x" + product_1.allProducts[1].getIcon();
        }
        getBuildingCoasts() {
            var fact = 5 - (product_1.allProducts[this.productid].distribution) / 4;
            return [fact * 10000,
                fact * 5,
                fact * 10];
        }
        getDailyInput2() {
            var needs = 0;
            var product = product_1.allProducts[this.productid];
            if (product.input2 !== undefined) {
                needs = this.workers * product.input2Amount / 25;
            }
            return needs;
        }
        update() {
            if (this.lastUpdate === undefined) {
                this.lastUpdate = this.city.world.game.date.getTime();
            }
            this.updateProduction();
            this.lastUpdate = this.city.world.game.date.getTime();
        }
        updateProduction() {
            if (this.workers === 0)
                return;
            var dayProcent = this.city.world.game.date.getHours() / 24;
            if (this.city.world.game.date.getDate() !== new Date(this.lastUpdate).getDate()) {
                dayProcent = 1;
            }
            var prod = this.productid;
            var totalDailyProduce = Math.round(this.workers * product_1.allProducts[prod].dailyProduce / 25);
            var totalDailyNeed1 = undefined;
            var totalDailyNeed2 = undefined;
            if (product_1.allProducts[prod].input1)
                totalDailyNeed1 = Math.round(this.workers * product_1.allProducts[prod].input1Amount / 25);
            if (product_1.allProducts[prod].input1)
                totalDailyNeed2 = Math.round(this.workers * product_1.allProducts[prod].input2Amount / 25);
            if (this.dailyProducedToday === 0 && totalDailyNeed1 !== undefined) {
                if (totalDailyNeed1 >= this.city.warehouse[product_1.allProducts[prod].input1]) {
                    console.log(totalDailyNeed1 + "x" + product_1.allProducts[prod].input1 + " needed");
                    return;
                }
                else {
                }
            }
            if (this.dailyProducedToday === 0 && totalDailyNeed2 !== undefined) {
                if (totalDailyNeed2 >= this.city.warehouse[product_1.allProducts[prod].input2]) {
                    console.log(totalDailyNeed2 + "x" + product_1.allProducts[prod].input2 + " needed");
                    return;
                }
            }
            var untilNow = Math.round(totalDailyProduce * dayProcent);
            if (untilNow > this.dailyProducedToday) {
                var diff = untilNow - this.dailyProducedToday;
                if (diff > 0) {
                    if (this.dailyProducedToday === 0) {
                        if (totalDailyNeed1 !== undefined)
                            this.city.warehouse[product_1.allProducts[prod].input1] -= totalDailyNeed1;
                        if (totalDailyNeed2 !== undefined)
                            this.city.warehouse[product_1.allProducts[prod].input2] -= totalDailyNeed2;
                    }
                    this.city.warehouse[prod] += diff;
                    console.log(diff + "x" + prod + " produced");
                    this.dailyProducedToday = this.dailyProducedToday + diff;
                }
            }
            if (dayProcent === 1) {
                this.dailyProducedToday = 0;
            }
        }
    }
    exports.Company = Company;
    function test() {
        var ids = [];
        var t = [];
        for (var x = 0; x < product_1.allProducts.length; x++) {
            var h = new Company(ids);
            ids.push(h.productid);
            t.push(h.productid);
        }
        t.sort();
        for (var x = 0; x < t.length; x++) {
            console.log(t[x]);
        }
    }
    exports.test = test;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGFueS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2dhbWUvY29tcGFueS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0lBSUEsU0FBUyxZQUFZLENBQUMsR0FBRztRQUNyQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFDRCxJQUFJLGlCQUFpQixHQUFhLFNBQVMsQ0FBQztJQUU1QyxTQUFTLG9CQUFvQixDQUFDLGFBQXVCLFNBQVM7UUFDMUQsSUFBSSxVQUFVLEtBQUssU0FBUztZQUN4QixVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixpQkFBaUIsR0FBRyxFQUFFLENBQUM7WUFDdkIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxxQkFBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHFCQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNsRCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMscUJBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDN0M7YUFDSjtTQUNKO1FBQ0QsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxLQUFLLFNBQVMsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ3hELElBQUksR0FBRyxZQUFZLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDOUMsSUFBSSxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFD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LENBQUM7WUFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDdkI7UUFDRCxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDVCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQVpELG9CQVlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWxsUHJvZHVjdHMgfSBmcm9tIFwiZ2FtZS9wcm9kdWN0XCI7XG5pbXBvcnQgeyBJY29ucyB9IGZyb20gXCJnYW1lL2ljb25zXCI7XG5pbXBvcnQgeyBDaXR5IH0gZnJvbSBcImdhbWUvY2l0eVwiO1xuXG5mdW5jdGlvbiBnZXRSYW5kb21JbnQobWF4KSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG1heCk7XG59XG52YXIgZGlzdHJpYnV0aW9uVGFibGU6IG51bWJlcltdID0gdW5kZWZpbmVkO1xuXG5mdW5jdGlvbiBnZXRSYW5kb21Db21wYW55VHlwZShub3RUaGlzSWRzOiBudW1iZXJbXSA9IHVuZGVmaW5lZCkge1xuICAgIGlmIChub3RUaGlzSWRzID09PSB1bmRlZmluZWQpXG4gICAgICAgIG5vdFRoaXNJZHMgPSBbXTtcbiAgICBpZiAoIWRpc3RyaWJ1dGlvblRhYmxlKSB7XG4gICAgICAgIGRpc3RyaWJ1dGlvblRhYmxlID0gW107XG4gICAgICAgIHZhciBkaXN0Q291bnQgPSAwO1xuICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFsbFByb2R1Y3RzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGFsbFByb2R1Y3RzW3hdLmRpc3RyaWJ1dGlvbjsgeSsrKSB7XG4gICAgICAgICAgICAgICAgZGlzdHJpYnV0aW9uVGFibGUucHVzaChhbGxQcm9kdWN0c1t4XS5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHJhbmQgPSB1bmRlZmluZWQ7XG4gICAgd2hpbGUgKHJhbmQgPT09IHVuZGVmaW5lZCB8fCBub3RUaGlzSWRzLmluZGV4T2YocmFuZCkgPiAtMSkge1xuICAgICAgICByYW5kID0gZ2V0UmFuZG9tSW50KGRpc3RyaWJ1dGlvblRhYmxlLmxlbmd0aCk7XG4gICAgICAgIHJhbmQgPSBkaXN0cmlidXRpb25UYWJsZVtyYW5kXTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmFuZDtcbn1cbmV4cG9ydCBjbGFzcyBDb21wYW55IHtcbiAgICBwcm9kdWN0aWQ6IG51bWJlcjtcbiAgICBidWlsZGluZ3M6IG51bWJlciA9IDA7XG4gICAgd29ya2VyczogbnVtYmVyID0gMDtcbiAgICBoYXNMaWNlbnNlID0gZmFsc2U7XG4gICAgdHlwZSA9IFwiQ29tcGFueVwiO1xuICAgIGRhaWx5UHJvZHVjZWRUb2RheTogbnVtYmVyO1xuICAgIGxhc3RVcGRhdGU6IG51bWJlcjtcbiAgICBjaXR5OiBDaXR5O1xuICAgIGNvbnN0cnVjdG9yKG5vdFRoaXNJZHM6IG51bWJlcltdID0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ID0gMDtcbiAgICAgICAgdGhpcy5wcm9kdWN0aWQgPSBnZXRSYW5kb21Db21wYW55VHlwZShub3RUaGlzSWRzKTtcbiAgICAgICAgdGhpcy5idWlsZGluZ3MgPSAwOy8vIGdldFJhbmRvbUludCgzKSsxO1xuICAgICAgICB0aGlzLndvcmtlcnMgPSAyNSAqIHRoaXMuYnVpbGRpbmdzO1xuICAgICAgICB0aGlzLmhhc0xpY2Vuc2UgPSAoYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdLmRpc3RyaWJ1dGlvbiA8PSA4KSA/IGZhbHNlIDogdHJ1ZTtcblxuICAgIH1cbiAgICBnZXRNYXhXb3JrZXJzKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1aWxkaW5ncyAqIDI1O1xuICAgIH1cbiAgICBnZXREYWlseVByb2R1Y2UoKTogbnVtYmVyIHtcbiAgICAgICAgdmFyIHByb2R1Y2UgPSB0aGlzLndvcmtlcnMgKiBhbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGFpbHlQcm9kdWNlIC8gMjU7XG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHByb2R1Y2UpO1xuICAgIH1cbiAgICBnZXREYWlseUlucHV0MSgpOiBudW1iZXIge1xuICAgICAgICB2YXIgbmVlZHMgPSAwO1xuICAgICAgICB2YXIgcHJvZHVjdCA9IGFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXTtcbiAgICAgICAgaWYgKHByb2R1Y3QuaW5wdXQxICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHZhciBwID0gYWxsUHJvZHVjdHNbcHJvZHVjdC5pbnB1dDFdO1xuICAgICAgICAgICAgbmVlZHMgPSB0aGlzLndvcmtlcnMgKiBwcm9kdWN0LmlucHV0MUFtb3VudCAvIDI1O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZWVkcztcbiAgICB9XG4gICAgZ2V0QnVpbGRpbmdDb2FzdHNBc0ljb24oKSB7XG4gICAgICAgIHZhciBhID0gdGhpcy5nZXRCdWlsZGluZ0NvYXN0cygpO1xuXG4gICAgICAgIHJldHVybiBhWzBdICsgSWNvbnMubW9uZXkgKyBcIjxici8+XCIgKyBhWzFdICsgXCJ4XCIgKyBhbGxQcm9kdWN0c1swXS5nZXRJY29uKCkgKyBcIjxici8+XCIgKyBhWzJdICsgXCJ4XCIgKyBhbGxQcm9kdWN0c1sxXS5nZXRJY29uKCk7XG4gICAgfVxuICAgIGdldEJ1aWxkaW5nQ29hc3RzKCkge1xuICAgICAgICB2YXIgZmFjdCA9IDUgLSAoYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdLmRpc3RyaWJ1dGlvbikgLyA0O1xuICAgICAgICByZXR1cm4gW2ZhY3QgKiAxMDAwMCxcbiAgICAgICAgZmFjdCAqIDUsXG4gICAgICAgIGZhY3QgKiAxMF1cbiAgICB9XG4gICAgZ2V0RGFpbHlJbnB1dDIoKTogbnVtYmVyIHtcbiAgICAgICAgdmFyIG5lZWRzID0gMDtcbiAgICAgICAgdmFyIHByb2R1Y3QgPSBhbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF07XG4gICAgICAgIGlmIChwcm9kdWN0LmlucHV0MiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBuZWVkcyA9IHRoaXMud29ya2VycyAqIHByb2R1Y3QuaW5wdXQyQW1vdW50IC8gMjU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5lZWRzO1xuICAgIH1cbiAgICB1cGRhdGUoKXtcbiAgICAgICAgIGlmICh0aGlzLmxhc3RVcGRhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy5jaXR5LndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51cGRhdGVQcm9kdWN0aW9uKCk7XG4gICAgICAgIHRoaXMubGFzdFVwZGF0ZSA9IHRoaXMuY2l0eS53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgIH1cbiAgICB1cGRhdGVQcm9kdWN0aW9uKCkge1xuICAgICAgIFxuICAgICAgICBpZih0aGlzLndvcmtlcnM9PT0wKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB2YXIgZGF5UHJvY2VudCA9IHRoaXMuY2l0eS53b3JsZC5nYW1lLmRhdGUuZ2V0SG91cnMoKSAvIDI0O1xuICAgICAgICBpZiAodGhpcy5jaXR5LndvcmxkLmdhbWUuZGF0ZS5nZXREYXRlKCkgIT09IG5ldyBEYXRlKHRoaXMubGFzdFVwZGF0ZSkuZ2V0RGF0ZSgpKSB7XG4gICAgICAgICAgICBkYXlQcm9jZW50ID0gMTtcblxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHByb2QgPSB0aGlzLnByb2R1Y3RpZDtcbiAgICAgICAgdmFyIHRvdGFsRGFpbHlQcm9kdWNlID0gTWF0aC5yb3VuZCh0aGlzLndvcmtlcnMgKiBhbGxQcm9kdWN0c1twcm9kXS5kYWlseVByb2R1Y2UgLyAyNSk7XG4gICAgICAgIHZhciB0b3RhbERhaWx5TmVlZDEgPSB1bmRlZmluZWQ7XG4gICAgICAgIHZhciB0b3RhbERhaWx5TmVlZDIgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChhbGxQcm9kdWN0c1twcm9kXS5pbnB1dDEpXG4gICAgICAgICAgICB0b3RhbERhaWx5TmVlZDEgPSBNYXRoLnJvdW5kKHRoaXMud29ya2VycyAqIGFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MUFtb3VudCAvIDI1KTtcbiAgICAgICAgaWYgKGFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MSlcbiAgICAgICAgICAgIHRvdGFsRGFpbHlOZWVkMiA9IE1hdGgucm91bmQodGhpcy53b3JrZXJzICogYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyQW1vdW50IC8gMjUpO1xuXG4gICAgICAgIGlmICh0aGlzLmRhaWx5UHJvZHVjZWRUb2RheT09PTAmJiB0b3RhbERhaWx5TmVlZDEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKHRvdGFsRGFpbHlOZWVkMSA+PSB0aGlzLmNpdHkud2FyZWhvdXNlW2FsbFByb2R1Y3RzW3Byb2RdLmlucHV0MV0pIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0b3RhbERhaWx5TmVlZDEgKyBcInhcIiArIGFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MSArIFwiIG5lZWRlZFwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5kYWlseVByb2R1Y2VkVG9kYXk9PT0wJiYgdG90YWxEYWlseU5lZWQyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlmICh0b3RhbERhaWx5TmVlZDIgPj0gdGhpcy5jaXR5LndhcmVob3VzZVthbGxQcm9kdWN0c1twcm9kXS5pbnB1dDJdKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2codG90YWxEYWlseU5lZWQyICsgXCJ4XCIgKyBhbGxQcm9kdWN0c1twcm9kXS5pbnB1dDIgKyBcIiBuZWVkZWRcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciB1bnRpbE5vdyA9IE1hdGgucm91bmQodG90YWxEYWlseVByb2R1Y2UgKiBkYXlQcm9jZW50KTtcbiAgICAgICAgaWYgKHVudGlsTm93ID4gdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkpIHtcbiAgICAgICAgICAgIHZhciBkaWZmID0gdW50aWxOb3cgLSB0aGlzLmRhaWx5UHJvZHVjZWRUb2RheTtcbiAgICAgICAgICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5PT09MCl7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRvdGFsRGFpbHlOZWVkMSE9PXVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXR5LndhcmVob3VzZVthbGxQcm9kdWN0c1twcm9kXS5pbnB1dDFdLT10b3RhbERhaWx5TmVlZDE7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRvdGFsRGFpbHlOZWVkMiE9PXVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXR5LndhcmVob3VzZVthbGxQcm9kdWN0c1twcm9kXS5pbnB1dDJdLT10b3RhbERhaWx5TmVlZDI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2l0eS53YXJlaG91c2VbcHJvZF0rPWRpZmY7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGlmZiArIFwieFwiICsgcHJvZCArIFwiIHByb2R1Y2VkXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ID0gdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgKyBkaWZmO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF5UHJvY2VudCA9PT0gMSkge1xuICAgICAgICAgICAgdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgPSAwO1xuICAgICAgICB9XG4gICAgfSBcbiAgICBcbn1cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0KCkge1xuICAgIHZhciBpZHMgPSBbXTtcbiAgICB2YXIgdCA9IFtdO1xuICAgIGZvciAodmFyIHggPSAwOyB4IDwgYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgdmFyIGggPSBuZXcgQ29tcGFueShpZHMpO1xuICAgICAgICBpZHMucHVzaChoLnByb2R1Y3RpZCk7XG4gICAgICAgIHQucHVzaChoLnByb2R1Y3RpZCk7XG4gICAgfVxuICAgIHQuc29ydCgpO1xuICAgIGZvciAodmFyIHggPSAwOyB4IDwgdC5sZW5ndGg7IHgrKykge1xuICAgICAgICBjb25zb2xlLmxvZyh0W3hdKTtcbiAgICB9XG59Il19