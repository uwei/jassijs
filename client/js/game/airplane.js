define(["require", "exports", "game/product", "game/airplanedialog"], function (require, exports, product_1, airplanedialog_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.allAirplaneTypes = exports.Airplane = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    //
    class Airplane {
        constructor(world) {
            this.status = "";
            this.loadedCount = 0;
            this.activeRoute = 0;
            this.squadron = []; //Geschwader
            this.type = "Airplane";
            this.world = world;
            this.route = [];
            this.products = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.products[x] = 0;
            }
            this.typeid = 1;
            /*  for(var x=0;x<4;x++){
                  var rt=new Route();
                  rt.cityid=x;
                  this.route.push(rt);
              }*/
        }
        getCurrentCity() {
            for (var x = 0; x < this.world.cities.length; x++) {
                if (this.world.cities[x].x === this.x && this.world.cities[x].y === this.y) {
                    return this.world.cities[x];
                }
            }
            return undefined;
        }
        updateSquadron() {
            var speed = allAirplaneTypes[this.typeid].speed;
            var capacity = allAirplaneTypes[this.typeid].capacity;
            for (var x = 0; x < this.squadron.length; x++) {
                speed = Math.min(this.squadron[x].speed, speed);
                capacity += this.squadron[x].capacity;
            }
            this.speed = speed;
            this.capacity = capacity;
        }
        render() {
            var _this = this;
            this.dom = document.createRange().createContextualFragment("<span style='font-size:20px;transform:rotate(0turn)' class='mdi mdi-airplane'></span>").children[0]; //document.createElement("span");
            this.dom.style.position = "absolute";
            this.action = "wait";
            this.dom.addEventListener("click", (ev) => {
                _this.onclick(ev);
                return undefined;
            });
            this.lastUpdate = this.world.game.date.getTime();
            this.update();
        }
        refreshLoadedCount() {
            var all = 0;
            for (var x = 0; x < product_1.allProducts.length; x++) {
                all += this.products[x];
            }
            this.loadedCount = all;
        }
        flyTo(city) {
            var x = city.x;
            var y = city.y;
            this.lastUpdate = this.world.game.date.getTime();
            // console.log("fly to " + city.name)
            this.action = "fly";
            this.status = "fly to " + city.name;
            this.targetX = x;
            this.targetY = y;
            this.update();
        }
        select() {
            if (this.dom)
                this.dom.style.color = "red";
        }
        unselect() {
            if (this.dom)
                this.dom.style.color = "black";
        }
        arrived() {
            console.log("target arrived");
            this.targetX = undefined;
            this.targetY = undefined;
            this.action = "wait";
            this.status = "";
            this.dom.style.transform = "rotate(0deg)";
            if (this.activeRoute !== -1) {
                console.log("unload now");
                this.action = "unload";
                this.status = "unload";
                this.lastAction = this.lastUpdate;
            }
        }
        calcNewPosition() {
            var pixelToTarget = Math.round(Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2))); //Pytharoras
            var fromX = this.x;
            var fromY = this.y;
            var fromTime = 0;
            var toX = this.targetX;
            var toY = this.targetY;
            var toTime = pixelToTarget / this.speed; //t=s/v; in Tage
            var speedVectorX = toX - fromX;
            var speedVectorY = toY - fromY;
            var speedVectorTime = (toTime - fromTime);
            var nowTime = (this.world.game.date.getTime() - this.lastUpdate) / (1000 * 60 * 60 * 24);
            var nowX = Math.round((nowTime / speedVectorTime) * speedVectorX + fromX);
            var nowY = Math.round((nowTime / speedVectorTime) * speedVectorY + fromY);
            if (nowTime >= toTime) {
                this.x = this.targetX;
                this.y = this.targetY;
                this.arrived();
            }
            else {
                var rad = Math.atan((fromX - toX) / (fromY - toY));
                var winkel = 0;
                if (fromY > toY) {
                    winkel = 360 - rad * (180) / Math.PI;
                }
                else {
                    winkel = 180 - rad * (180) / Math.PI;
                }
                var s = ("" + winkel).replace(",", ".");
                this.dom.style.transform = "rotate(" + s + "deg)";
                // console.log(pixelToTarget+" pixel in "+toTime+" seconds. Position "+nowX+" "+nowY+" lastupdate "+nowTime+" "+winkel+"Â°");
                this.x = nowX;
                this.y = nowY;
            }
        }
        update() {
            if (this.loadedCount === this.capacity && !this.dom.classList.contains("airplane_fullloaded")) {
                this.dom.classList.add("airplane_fullloaded");
            }
            if (this.loadedCount !== this.capacity && !this.dom.classList.contains("airplane_fullloaded")) {
                this.dom.classList.remove("airplane_fullloaded");
            }
            if (this.targetX !== undefined) {
                this.calcNewPosition();
            }
            this.lastUpdate = this.world.game.date.getTime();
            this.dom.style.top = this.y + "px";
            this.dom.style.left = (this.x - 15) + "px";
            if (this.activeRoute !== -1 && this.route.length > 1) {
                if (this.action === "unload" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    // console.log("load now");
                    this.action = "load";
                    this.status = "load";
                    this.lastAction = this.lastUpdate;
                    if (this.activeRoute >= this.route.length) {
                        this.activeRoute = 0;
                    }
                    else
                        this.route[this.activeRoute].unload();
                    airplanedialog_1.AirplaneDialog.getInstance().update();
                }
                if (this.action === "load" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    this.lastAction = this.lastUpdate;
                    if (this.activeRoute >= this.route.length)
                        this.activeRoute = 0;
                    else
                        this.route[this.activeRoute].load();
                    airplanedialog_1.AirplaneDialog.getInstance().update();
                    this.activeRoute++;
                    if (this.activeRoute >= this.route.length)
                        this.activeRoute = 0;
                    var city = this.world.cities[this.route[this.activeRoute].cityid];
                    this.flyTo(city);
                }
            }
        }
        onclick(th) {
            var _a;
            th.preventDefault();
            th.stopPropagation();
            console.log(this.name);
            (_a = this.world.selection) === null || _a === void 0 ? void 0 : _a.unselect();
            this.world.selection = this;
            this.select();
            var h = airplanedialog_1.AirplaneDialog.getInstance();
            h.airplane = this;
            h.show();
        }
        getDailyCosts() {
            var ret = allAirplaneTypes[this.typeid].costs;
            for (var x = 0; x < this.squadron.length; x++) {
                ret += allAirplaneTypes[this.squadron[x].typeid].costs;
            }
            return ret;
        }
    }
    exports.Airplane = Airplane;
    var allAirplaneTypes = [
        { typeid: 0, model: "Airplane A", speed: 200, capacity: 200, costs: 60, buildDays: 25, buildingCosts: 20000, buildingMaterial: [0, 0, 0, 40, 0, 10, 0, 10, 0, 10, 0, 0, 0, 0, 10] },
        { typeid: 1, model: "Airplane B", speed: 210, capacity: 300, costs: 90, buildDays: 30, buildingCosts: 41000, buildingMaterial: [0, 0, 0, 60, 0, 20, 0, 20, 0, 20, 0, 0, 0, 0, 20] },
        { typeid: 2, model: "Airplane C", speed: 220, capacity: 500, costs: 150, buildDays: 39, buildingCosts: 60000, buildingMaterial: [0, 0, 0, 100, 0, 30, 0, 30, 0, 30, 0, 0, 0, 0, 30] },
        { typeid: 3, model: "Airplane D", speed: 240, capacity: 650, costs: 180, buildDays: 45, buildingCosts: 75000, buildingMaterial: [0, 0, 0, 120, 0, 40, 0, 40, 0, 40, 0, 0, 0, 0, 40] },
        { typeid: 4, model: "Airplane E", speed: 260, capacity: 1000, costs: 270, buildDays: 56, buildingCosts: 150000, buildingMaterial: [0, 0, 0, 200, 0, 50, 0, 50, 0, 50, 0, 0, 0, 0, 50] },
        { typeid: 5, model: "Airplane F", speed: 300, capacity: 2000, costs: 500, buildDays: 79, buildingCosts: 210000, buildingMaterial: [0, 0, 0, 400, 0, 100, 0, 100, 0, 100, 0, 0, 0, 0, 100] },
    ];
    exports.allAirplaneTypes = allAirplaneTypes;
});
//<span style='font-size:100px;'>&#9951;</span>
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlycGxhbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL2FpcnBsYW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFNQSxTQUFTLFlBQVksQ0FBQyxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUNELEVBQUU7SUFDRixNQUFhLFFBQVE7UUF1QmpCLFlBQVksS0FBWTtZQVJ4QixXQUFNLEdBQVcsRUFBRSxDQUFDO1lBSXBCLGdCQUFXLEdBQVEsQ0FBQyxDQUFDO1lBQ3JCLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLGFBQVEsR0FBWSxFQUFFLENBQUMsQ0FBQSxZQUFZO1lBQ25DLFNBQUksR0FBRyxVQUFVLENBQUM7WUFFZCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxxQkFBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7YUFFeEI7WUFDRCxJQUFJLENBQUMsTUFBTSxHQUFDLENBQUMsQ0FBQztZQUNkOzs7O2lCQUlLO1FBQ1QsQ0FBQztRQUNELGNBQWM7WUFFVixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMvQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBRyxJQUFJLENBQUMs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bGRcIjtcbmltcG9ydCB7IGFsbFByb2R1Y3RzIH0gZnJvbSBcImdhbWUvcHJvZHVjdFwiO1xuaW1wb3J0IHsgQWlycGxhbmVEaWFsb2cgfSBmcm9tIFwiZ2FtZS9haXJwbGFuZWRpYWxvZ1wiO1xuaW1wb3J0IHsgUm91dGUgfSBmcm9tIFwiZ2FtZS9yb3V0ZVwiO1xuaW1wb3J0IHsgQ2l0eSB9IGZyb20gXCJnYW1lL2NpdHlcIjtcblxuZnVuY3Rpb24gZ2V0UmFuZG9tSW50KG1heCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpO1xufVxuLy9cbmV4cG9ydCBjbGFzcyBBaXJwbGFuZSB7XG4gICAgdHlwZWlkOm51bWJlcjtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgYWN0aW9uOiBzdHJpbmc7XG4gICAgbGFzdEFjdGlvbjogbnVtYmVyO1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gICAgLy9waXhlbCBwcm8gc2Vjb25kXG4gICAgc3BlZWQ6IG51bWJlcjtcbiAgICBsYXN0VXBkYXRlOiBudW1iZXI7XG4gICAgdGFyZ2V0WDogbnVtYmVyO1xuICAgIHRhcmdldFk6IG51bWJlcjtcbiAgICBkb206IEhUTUxTcGFuRWxlbWVudDtcbiAgICB3b3JsZDogV29ybGQ7XG4gICAgcHJvZHVjdHM7XG4gICAgc3RhdHVzOiBzdHJpbmcgPSBcIlwiO1xuICAgIHJvdXRlOiBSb3V0ZVtdO1xuICAgIGNvc3RzOm51bWJlcjtcbiAgICBjYXBhY2l0eTpudW1iZXI7XG4gICAgbG9hZGVkQ291bnQ6bnVtYmVyPTA7XG4gICAgYWN0aXZlUm91dGUgPSAwO1xuICAgIHNxdWFkcm9uOkFpcnBsYW5lW109W107Ly9HZXNjaHdhZGVyXG4gICAgdHlwZSA9IFwiQWlycGxhbmVcIjtcbiAgICBjb25zdHJ1Y3Rvcih3b3JsZDogV29ybGQpIHtcbiAgICAgICAgdGhpcy53b3JsZCA9IHdvcmxkO1xuICAgICAgICB0aGlzLnJvdXRlID0gW107XG4gICAgICAgICB0aGlzLnByb2R1Y3RzID0gW107XG4gICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBhbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdGhpcy5wcm9kdWN0c1t4XSA9IDA7XG5cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnR5cGVpZD0xO1xuICAgICAgICAvKiAgZm9yKHZhciB4PTA7eDw0O3grKyl7XG4gICAgICAgICAgICAgIHZhciBydD1uZXcgUm91dGUoKTtcbiAgICAgICAgICAgICAgcnQuY2l0eWlkPXg7XG4gICAgICAgICAgICAgIHRoaXMucm91dGUucHVzaChydCk7XG4gICAgICAgICAgfSovXG4gICAgfSBcbiAgICBnZXRDdXJyZW50Q2l0eSgpe1xuICAgICAgICBcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLndvcmxkLmNpdGllcy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgaWYgKHRoaXMud29ybGQuY2l0aWVzW3hdLng9PT10aGlzLngmJnRoaXMud29ybGQuY2l0aWVzW3hdLnk9PT10aGlzLnkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5jaXRpZXNbeF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdXBkYXRlU3F1YWRyb24oKXtcbiAgICAgICAgdmFyIHNwZWVkPWFsbEFpcnBsYW5lVHlwZXNbdGhpcy50eXBlaWRdLnNwZWVkO1xuICAgICAgICB2YXIgY2FwYWNpdHk9YWxsQWlycGxhbmVUeXBlc1t0aGlzLnR5cGVpZF0uY2FwYWNpdHk7XG4gICAgICAgIGZvcih2YXIgeD0wO3g8dGhpcy5zcXVhZHJvbi5sZW5ndGg7eCsrKXtcbiAgICAgICAgICAgIHNwZWVkPU1hdGgubWluKHRoaXMuc3F1YWRyb25beF0uc3BlZWQsc3BlZWQpO1xuICAgICAgICAgICAgY2FwYWNpdHkrPXRoaXMuc3F1YWRyb25beF0uY2FwYWNpdHk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zcGVlZD1zcGVlZDtcbiAgICAgICAgdGhpcy5jYXBhY2l0eT1jYXBhY2l0eTtcbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB0aGlzLmRvbSA9IDxhbnk+ZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKS5jcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQoXCI8c3BhbiBzdHlsZT0nZm9udC1zaXplOjIwcHg7dHJhbnNmb3JtOnJvdGF0ZSgwdHVybiknIGNsYXNzPSdtZGkgbWRpLWFpcnBsYW5lJz48L3NwYW4+XCIpLmNoaWxkcmVuWzBdOy8vZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuXG4gICAgICAgIHRoaXMuYWN0aW9uID0gXCJ3YWl0XCI7XG4gICAgICAgXG4gICAgICAgXG4gICAgICAgIHRoaXMuZG9tLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIF90aGlzLm9uY2xpY2soZXYpO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubGFzdFVwZGF0ZSA9IHRoaXMud29ybGQuZ2FtZS5kYXRlLmdldFRpbWUoKTtcbiAgICAgICAgdGhpcy51cGRhdGUoKTtcblxuICAgIH1cbiAgICByZWZyZXNoTG9hZGVkQ291bnQoKXtcbiAgICAgICAgdmFyIGFsbD0wO1xuICAgICAgICBmb3IodmFyIHg9MDt4PGFsbFByb2R1Y3RzLmxlbmd0aDt4Kyspe1xuICAgICAgICAgICAgYWxsKz10aGlzLnByb2R1Y3RzW3hdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9hZGVkQ291bnQ9YWxsO1xuICAgIH1cbiAgICBmbHlUbyhjaXR5OiBDaXR5KSB7XG4gICAgICAgIHZhciB4ID0gY2l0eS54O1xuICAgICAgICB2YXIgeSA9IGNpdHkueTtcblxuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiZmx5IHRvIFwiICsgY2l0eS5uYW1lKVxuICAgICAgICB0aGlzLmFjdGlvbiA9IFwiZmx5XCI7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gXCJmbHkgdG8gXCIgKyBjaXR5Lm5hbWU7XG4gICAgICAgIHRoaXMudGFyZ2V0WCA9IHg7XG4gICAgICAgIHRoaXMudGFyZ2V0WSA9IHk7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgICAgXG4gICAgfVxuICAgIHNlbGVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZG9tKVxuICAgICAgICAgICAgdGhpcy5kb20uc3R5bGUuY29sb3IgPSBcInJlZFwiO1xuICAgIH1cbiAgICB1bnNlbGVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZG9tKVxuICAgICAgICAgICAgdGhpcy5kb20uc3R5bGUuY29sb3IgPSBcImJsYWNrXCI7XG4gICAgfVxuICAgIGFycml2ZWQoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGFyZ2V0IGFycml2ZWRcIik7XG4gICAgICAgIHRoaXMudGFyZ2V0WCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy50YXJnZXRZID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFjdGlvbiA9IFwid2FpdFwiO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IFwiXCI7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlKDBkZWcpXCI7XG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZVJvdXRlICE9PSAtMSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmxvYWQgbm93XCIpO1xuICAgICAgICAgICAgdGhpcy5hY3Rpb24gPSBcInVubG9hZFwiO1xuICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBcInVubG9hZFwiO1xuICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhbGNOZXdQb3NpdGlvbigpIHtcbiAgICAgICAgdmFyIHBpeGVsVG9UYXJnZXQgPSBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyh0aGlzLnRhcmdldFggLSB0aGlzLngsIDIpICsgTWF0aC5wb3codGhpcy50YXJnZXRZIC0gdGhpcy55LCAyKSkpOy8vUHl0aGFyb3Jhc1xuICAgICAgICB2YXIgZnJvbVggPSB0aGlzLng7XG4gICAgICAgIHZhciBmcm9tWSA9IHRoaXMueTtcbiAgICAgICAgdmFyIGZyb21UaW1lID0gMDtcbiAgICAgICAgdmFyIHRvWCA9IHRoaXMudGFyZ2V0WDtcbiAgICAgICAgdmFyIHRvWSA9IHRoaXMudGFyZ2V0WTtcbiAgICAgICAgdmFyIHRvVGltZSA9IHBpeGVsVG9UYXJnZXQgLyB0aGlzLnNwZWVkOyAgICAvL3Q9cy92OyBpbiBUYWdlXG4gICAgICAgIHZhciBzcGVlZFZlY3RvclggPSB0b1ggLSBmcm9tWDtcbiAgICAgICAgdmFyIHNwZWVkVmVjdG9yWSA9IHRvWSAtIGZyb21ZO1xuICAgICAgICB2YXIgc3BlZWRWZWN0b3JUaW1lID0gKHRvVGltZSAtIGZyb21UaW1lKTtcbiAgICAgICAgdmFyIG5vd1RpbWUgPSAodGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpIC0gdGhpcy5sYXN0VXBkYXRlKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICAgICAgdmFyIG5vd1ggPSBNYXRoLnJvdW5kKChub3dUaW1lIC8gc3BlZWRWZWN0b3JUaW1lKSAqIHNwZWVkVmVjdG9yWCArIGZyb21YKTtcbiAgICAgICAgdmFyIG5vd1kgPSBNYXRoLnJvdW5kKChub3dUaW1lIC8gc3BlZWRWZWN0b3JUaW1lKSAqIHNwZWVkVmVjdG9yWSArIGZyb21ZKTtcbiAgICAgICAgaWYgKG5vd1RpbWUgPj0gdG9UaW1lKSB7XG4gICAgICAgICAgICB0aGlzLnggPSB0aGlzLnRhcmdldFg7XG4gICAgICAgICAgICB0aGlzLnkgPSB0aGlzLnRhcmdldFk7XG4gICAgICAgICAgICB0aGlzLmFycml2ZWQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciByYWQgPSBNYXRoLmF0YW4oKGZyb21YIC0gdG9YKSAvIChmcm9tWSAtIHRvWSkpO1xuICAgICAgICAgICAgdmFyIHdpbmtlbCA9IDA7XG4gICAgICAgICAgICBpZiAoZnJvbVkgPiB0b1kpIHtcbiAgICAgICAgICAgICAgICB3aW5rZWwgPSAzNjAgLSByYWQgKiAoMTgwKSAvIE1hdGguUEk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHdpbmtlbCA9IDE4MCAtIHJhZCAqICgxODApIC8gTWF0aC5QSTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzID0gKFwiXCIgKyB3aW5rZWwpLnJlcGxhY2UoXCIsXCIsIFwiLlwiKTtcbiAgICAgICAgICAgIHRoaXMuZG9tLnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlKFwiICsgcyArIFwiZGVnKVwiO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2cocGl4ZWxUb1RhcmdldCtcIiBwaXhlbCBpbiBcIit0b1RpbWUrXCIgc2Vjb25kcy4gUG9zaXRpb24gXCIrbm93WCtcIiBcIitub3dZK1wiIGxhc3R1cGRhdGUgXCIrbm93VGltZStcIiBcIit3aW5rZWwrXCLCsFwiKTtcbiAgICAgICAgICAgIHRoaXMueCA9IG5vd1g7XG4gICAgICAgICAgICB0aGlzLnkgPSBub3dZO1xuICAgICAgICB9XG4gICAgfVxuICAgIHVwZGF0ZSgpIHtcbiAgICAgICAgaWYodGhpcy5sb2FkZWRDb3VudD09PXRoaXMuY2FwYWNpdHkmJiF0aGlzLmRvbS5jbGFzc0xpc3QuY29udGFpbnMoXCJhaXJwbGFuZV9mdWxsbG9hZGVkXCIpKXtcbiAgICAgICAgICAgIHRoaXMuZG9tLmNsYXNzTGlzdC5hZGQoXCJhaXJwbGFuZV9mdWxsbG9hZGVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmKHRoaXMubG9hZGVkQ291bnQhPT10aGlzLmNhcGFjaXR5JiYhdGhpcy5kb20uY2xhc3NMaXN0LmNvbnRhaW5zKFwiYWlycGxhbmVfZnVsbGxvYWRlZFwiKSl7XG4gICAgICAgICAgICB0aGlzLmRvbS5jbGFzc0xpc3QucmVtb3ZlKFwiYWlycGxhbmVfZnVsbGxvYWRlZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy50YXJnZXRYICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FsY05ld1Bvc2l0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmRvbS5zdHlsZS50b3AgPSB0aGlzLnkgKyBcInB4XCI7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmxlZnQgPSAodGhpcy54IC0gMTUpICsgXCJweFwiO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVSb3V0ZSAhPT0gLTEgJiYgdGhpcy5yb3V0ZS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5hY3Rpb24gPT09IFwidW5sb2FkXCIgJiYgKHRoaXMubGFzdFVwZGF0ZSAtIHRoaXMubGFzdEFjdGlvbikgPiAoMyAqIDEwMDAgKiA2MCAqIDYwKSkge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwibG9hZCBub3dcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5hY3Rpb24gPSBcImxvYWRcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwibG9hZFwiO1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEFjdGlvbiA9IHRoaXMubGFzdFVwZGF0ZTtcbiAgICAgICAgICAgICAgICAgaWYodGhpcy5hY3RpdmVSb3V0ZT49dGhpcy5yb3V0ZS5sZW5ndGgpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVJvdXRlPTA7XG4gICAgICAgICAgICAgICAgIH1lbHNlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVbdGhpcy5hY3RpdmVSb3V0ZV0udW5sb2FkKCk7XG4gICAgICAgICAgICAgICAgQWlycGxhbmVEaWFsb2cuZ2V0SW5zdGFuY2UoKS51cGRhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGlvbiA9PT0gXCJsb2FkXCIgJiYgKHRoaXMubGFzdFVwZGF0ZSAtIHRoaXMubGFzdEFjdGlvbikgPiAoMyAqIDEwMDAgKiA2MCAqIDYwKSkge1xuXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuYWN0aXZlUm91dGU+PXRoaXMucm91dGUubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVJvdXRlPTA7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJvdXRlW3RoaXMuYWN0aXZlUm91dGVdLmxvYWQoKTtcbiAgICAgICAgICAgICAgICBBaXJwbGFuZURpYWxvZy5nZXRJbnN0YW5jZSgpLnVwZGF0ZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUm91dGUrKztcbiAgICAgICAgICAgICAgICBpZih0aGlzLmFjdGl2ZVJvdXRlPj10aGlzLnJvdXRlLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVSb3V0ZT0wO1xuICAgICAgICAgICAgICAgIHZhciBjaXR5ID0gdGhpcy53b3JsZC5jaXRpZXNbdGhpcy5yb3V0ZVt0aGlzLmFjdGl2ZVJvdXRlXS5jaXR5aWRdO1xuICAgICAgICAgICAgICAgIHRoaXMuZmx5VG8oY2l0eSk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBvbmNsaWNrKHRoOiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIHRoLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLm5hbWUpO1xuICAgICAgICB0aGlzLndvcmxkLnNlbGVjdGlvbj8udW5zZWxlY3QoKTtcbiAgICAgICAgdGhpcy53b3JsZC5zZWxlY3Rpb24gPSB0aGlzO1xuICAgICAgICB0aGlzLnNlbGVjdCgpO1xuICAgICAgICB2YXIgaCA9IEFpcnBsYW5lRGlhbG9nLmdldEluc3RhbmNlKCk7XG4gICAgICAgIGguYWlycGxhbmUgPSB0aGlzO1xuICAgICAgICBoLnNob3coKTtcblxuICAgIH1cbiAgICBnZXREYWlseUNvc3RzKCl7XG4gICAgICAgIHZhciByZXQ9YWxsQWlycGxhbmVUeXBlc1t0aGlzLnR5cGVpZF0uY29zdHM7XG4gICAgICAgIGZvcih2YXIgeD0wO3g8dGhpcy5zcXVhZHJvbi5sZW5ndGg7eCsrKXtcbiAgICAgICAgICAgIHJldCs9YWxsQWlycGxhbmVUeXBlc1t0aGlzLnNxdWFkcm9uW3hdLnR5cGVpZF0uY29zdHM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG59XG52YXIgYWxsQWlycGxhbmVUeXBlcz1bXG57dHlwZWlkOjAsbW9kZWw6XCJBaXJwbGFuZSBBXCIsc3BlZWQ6MjAwLGNhcGFjaXR5OjIwMCwgY29zdHM6NjAsYnVpbGREYXlzOjI1LGJ1aWxkaW5nQ29zdHM6MjAwMDAsYnVpbGRpbmdNYXRlcmlhbDpbMCwwLDAsNDAsMCwxMCwwLDEwLDAsMTAsMCwwLDAsMCwxMF19LFxue3R5cGVpZDoxLG1vZGVsOlwiQWlycGxhbmUgQlwiLHNwZWVkOjIxMCxjYXBhY2l0eTozMDAsIGNvc3RzOjkwLGJ1aWxkRGF5czozMCxidWlsZGluZ0Nvc3RzOjQxMDAwLGJ1aWxkaW5nTWF0ZXJpYWw6WzAsMCwwLDYwLDAsMjAsMCwyMCwwLDIwLDAsMCwwLDAsMjBdfSxcbnt0eXBlaWQ6Mixtb2RlbDpcIkFpcnBsYW5lIENcIixzcGVlZDoyMjAsY2FwYWNpdHk6NTAwLCBjb3N0czoxNTAsYnVpbGREYXlzOjM5LGJ1aWxkaW5nQ29zdHM6NjAwMDAsYnVpbGRpbmdNYXRlcmlhbDpbMCwwLDAsMTAwLDAsMzAsMCwzMCwwLDMwLDAsMCwwLDAsMzBdfSxcbnt0eXBlaWQ6Myxtb2RlbDpcIkFpcnBsYW5lIERcIixzcGVlZDoyNDAsY2FwYWNpdHk6NjUwLCBjb3N0czoxODAsYnVpbGREYXlzOjQ1LGJ1aWxkaW5nQ29zdHM6NzUwMDAsYnVpbGRpbmdNYXRlcmlhbDpbMCwwLDAsMTIwLDAsNDAsMCw0MCwwLDQwLDAsMCwwLDAsNDBdfSxcbnt0eXBlaWQ6NCxtb2RlbDpcIkFpcnBsYW5lIEVcIixzcGVlZDoyNjAsY2FwYWNpdHk6MTAwMCwgY29zdHM6MjcwLGJ1aWxkRGF5czo1NixidWlsZGluZ0Nvc3RzOjE1MDAwMCxidWlsZGluZ01hdGVyaWFsOlswLDAsMCwyMDAsMCw1MCwwLDUwLDAsNTAsMCwwLDAsMCw1MF19LFxue3R5cGVpZDo1LG1vZGVsOlwiQWlycGxhbmUgRlwiLHNwZWVkOjMwMCxjYXBhY2l0eToyMDAwLCBjb3N0czo1MDAsYnVpbGREYXlzOjc5LGJ1aWxkaW5nQ29zdHM6MjEwMDAwLGJ1aWxkaW5nTWF0ZXJpYWw6WzAsMCwwLDQwMCwwLDEwMCwwLDEwMCwwLDEwMCwwLDAsMCwwLDEwMF19LFxuXTtcbmV4cG9ydHthbGxBaXJwbGFuZVR5cGVzfTtcbi8vPHNwYW4gc3R5bGU9J2ZvbnQtc2l6ZToxMDBweDsnPiYjOTk1MTs8L3NwYW4+Il19