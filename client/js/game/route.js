define(["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Route = void 0;
    class Route {
        constructor() {
            this.type = "Route";
            this.unloadMarketAmount = [];
            this.unloadMarketPrice = [];
            this.unloadShopAmount = [];
            this.loadMarketAmount = [];
            this.loadMarketPrice = [];
            this.loadShopAmount = [];
            this.loadShopUntilAmount = [];
            for (var x = 0; x < parameter.allProducts.length; x++) {
                this.unloadMarketAmount.push(undefined);
                this.unloadMarketPrice.push(parameter.allProducts[x].priceSelling);
                this.unloadShopAmount.push(undefined);
                this.loadMarketAmount.push(undefined);
                this.loadMarketPrice.push(parameter.allProducts[x].pricePurchase);
                this.loadShopAmount.push(undefined);
                this.loadShopUntilAmount.push(undefined);
            }
        }
        unloadMarket() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < parameter.allProducts.length; x++) {
                var max = this.airplane.products[x];
                if (this.unloadMarketAmount[x] !== undefined) {
                    max = Math.min(this.airplane.products[x], this.unloadMarketAmount[x]);
                    if (max < 0)
                        max = 0;
                }
                else
                    max = 0;
                if (max) {
                    for (var y = 0; y < max; y++) {
                        var price = parameter.allProducts[x].calcPrice(city.people, city.market[x], false); //city.isProducedHere(x));
                        if (price >= this.unloadMarketPrice[x]) {
                            city.world.game.changeMoney(1 * price, "airplane sells from market", city);
                            city.market[x] += 1;
                            this.airplane.products[x] -= 1;
                            this.airplane.refreshLoadedCount();
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        unloadShop() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < parameter.allProducts.length; x++) {
                var max = this.unloadShopAmount[x];
                if (max !== undefined) {
                    max = Math.min(max, this.airplane.products[x]);
                    if (max) {
                        var diff = city.shops * parameter.capacityShop - city.getCompleteAmount();
                        if (diff > 0)
                            max = Math.min(max, diff);
                        else
                            max = 0;
                        this.airplane.products[x] -= max;
                        this.airplane.refreshLoadedCount();
                        city.shop[x] += max;
                        diff = city.shops * parameter.capacityShop - city.getCompleteAmount();
                        if (diff <= 0) {
                            city.domShopfull.style.display = "initial";
                        }
                    }
                }
            }
        }
        loadShop() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < parameter.allProducts.length; x++) {
                var max = this.loadShopUntilAmount[x];
                if (max === undefined) {
                    max = this.loadShopAmount[x];
                    if (max && max > city.shop[x])
                        max = city.shop[x];
                }
                else {
                    max = city.shop[x] - this.loadShopUntilAmount[x];
                }
                if (max < 0)
                    max = 0;
                if (this.maxLoad !== undefined && max !== undefined) {
                    max = Math.min(this.maxLoad - this.airplane.products[x], max);
                    if (max < 0)
                        max = 0;
                }
                if (max && city.shopMinStock[x]) {
                    if (city.shop[x] - max < city.shopMinStock[x]) {
                        max = city.shop[x] - city.shopMinStock[x];
                        if (max < 0)
                            max = 0;
                    }
                }
                if (max && max > (this.airplane.capacity - this.airplane.loadedCount))
                    max = this.airplane.capacity - this.airplane.loadedCount;
                if (max) {
                    this.airplane.products[x] += max;
                    this.airplane.refreshLoadedCount();
                    city.shop[x] -= max;
                }
            }
        }
        loadMarket() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < parameter.allProducts.length; x++) {
                var max = this.loadMarketAmount[x];
                if (this.maxLoad !== undefined && max) {
                    max = Math.min(max, this.maxLoad - this.airplane.products[x]);
                    if (max < 0)
                        max = 0;
                }
                if (max && max > (this.airplane.capacity - this.airplane.loadedCount))
                    max = this.airplane.capacity - this.airplane.loadedCount;
                if (max) {
                    for (var y = 0; y < max; y++) {
                        var price = parameter.allProducts[x].calcPrice(city.people, city.market[x] - 1, city.isProducedHere(x));
                        if (price <= this.loadMarketPrice[x]) {
                            city.world.game.changeMoney(-1 * price, "airplane buys from market", city);
                            city.market[x] -= 1;
                            this.airplane.products[x] += 1;
                            this.airplane.refreshLoadedCount();
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        load() {
            this.loadShop();
            this.loadMarket();
        }
        unload() {
            this.unloadMarket();
            this.unloadShop();
        }
    }
    exports.Route = Route;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL3JvdXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFHQSxNQUFhLEtBQUs7UUFZZDtZQURBLFNBQUksR0FBRyxPQUFPLENBQUM7WUFFWCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxFQUFFLENBQUM7WUFDOUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNuRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN4QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ25FLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ2xFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dC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RSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3hHLElBQUksS0FBSyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUU7NEJBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEVBQUUsMkJBQTJCLEVBQUUsSUFBSSxDQUFDLENBQUM7NEJBQzNFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzt5QkFDdEM7NkJBQU07NEJBQ0gsTUFBTTt5QkFFVDtxQkFDSjtpQkFFSjthQUNKO1FBQ0wsQ0FBQztRQUNELElBQUk7WUFDQSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3RCLENBQUM7UUFDRCxNQUFNO1lBRUYsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN0QixDQUFDO0tBQ0o7SUExSkQsc0JBMEpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWlycGxhbmUgfSBmcm9tIFwiZ2FtZS9haXJwbGFuZVwiO1xuXG5cbmV4cG9ydCBjbGFzcyBSb3V0ZSB7XG4gICAgY2l0eWlkOiBudW1iZXI7XG4gICAgbWF4TG9hZDogbnVtYmVyO1xuICAgIHVubG9hZE1hcmtldEFtb3VudDogbnVtYmVyW107XG4gICAgdW5sb2FkTWFya2V0UHJpY2U6IG51bWJlcltdO1xuICAgIHVubG9hZFNob3BBbW91bnQ6IG51bWJlcltdO1xuICAgIGxvYWRNYXJrZXRBbW91bnQ6IG51bWJlcltdO1xuICAgIGxvYWRNYXJrZXRQcmljZTogbnVtYmVyW107XG4gICAgbG9hZFNob3BBbW91bnQ6IG51bWJlcltdO1xuICAgIGxvYWRTaG9wVW50aWxBbW91bnQ6IG51bWJlcltdO1xuICAgIGFpcnBsYW5lOiBBaXJwbGFuZTtcbiAgICB0eXBlID0gXCJSb3V0ZVwiO1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnVubG9hZE1hcmtldEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLnVubG9hZE1hcmtldFByaWNlID0gW107XG4gICAgICAgIHRoaXMudW5sb2FkU2hvcEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLmxvYWRNYXJrZXRBbW91bnQgPSBbXTtcbiAgICAgICAgdGhpcy5sb2FkTWFya2V0UHJpY2UgPSBbXTtcbiAgICAgICAgdGhpcy5sb2FkU2hvcEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLmxvYWRTaG9wVW50aWxBbW91bnQgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBwYXJhbWV0ZXIuYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIHRoaXMudW5sb2FkTWFya2V0QW1vdW50LnB1c2godW5kZWZpbmVkKTtcbiAgICAgICAgICAgIHRoaXMudW5sb2FkTWFya2V0UHJpY2UucHVzaChwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbeF0ucHJpY2VTZWxsaW5nKTtcbiAgICAgICAgICAgIHRoaXMudW5sb2FkU2hvcEFtb3VudC5wdXNoKHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRNYXJrZXRBbW91bnQucHVzaCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgdGhpcy5sb2FkTWFya2V0UHJpY2UucHVzaChwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbeF0ucHJpY2VQdXJjaGFzZSk7XG4gICAgICAgICAgICB0aGlzLmxvYWRTaG9wQW1vdW50LnB1c2godW5kZWZpbmVkKTtcbiAgICAgICAgICAgIHRoaXMubG9hZFNob3BVbnRpbEFtb3VudC5wdXNoKHVuZGVmaW5lZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdW5sb2FkTWFya2V0KCkge1xuICAgICAgICB2YXIgY2l0eSA9IHRoaXMuYWlycGxhbmUud29ybGQuY2l0aWVzW3RoaXMuY2l0eWlkXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBwYXJhbWV0ZXIuYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIHZhciBtYXggPSB0aGlzLmFpcnBsYW5lLnByb2R1Y3RzW3hdO1xuXG4gICAgICAgICAgICBpZiAodGhpcy51bmxvYWRNYXJrZXRBbW91bnRbeF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1heCA9IE1hdGgubWluKHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0sIHRoaXMudW5sb2FkTWFya2V0QW1vdW50W3hdKTtcbiAgICAgICAgICAgICAgICBpZiAobWF4IDwgMClcbiAgICAgICAgICAgICAgICAgICAgbWF4ID0gMDtcbiAgICAgICAgICAgIH0gZWxzZVxuICAgICAgICAgICAgICAgIG1heCA9IDA7XG4gICAgICAgICAgICBpZiAobWF4KSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCBtYXg7IHkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJpY2UgPSBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbeF0uY2FsY1ByaWNlKGNpdHkucGVvcGxlLCBjaXR5Lm1hcmtldFt4XSwgZmFsc2UpOy8vY2l0eS5pc1Byb2R1Y2VkSGVyZSh4KSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmljZSA+PSB0aGlzLnVubG9hZE1hcmtldFByaWNlW3hdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaXR5LndvcmxkLmdhbWUuY2hhbmdlTW9uZXkoMSAqIHByaWNlLCBcImFpcnBsYW5lIHNlbGxzIGZyb20gbWFya2V0XCIsIGNpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2l0eS5tYXJrZXRbeF0gKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucmVmcmVzaExvYWRlZENvdW50KCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdW5sb2FkU2hvcCgpIHtcbiAgICAgICAgdmFyIGNpdHkgPSB0aGlzLmFpcnBsYW5lLndvcmxkLmNpdGllc1t0aGlzLmNpdHlpZF07XG4gICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgcGFyYW1ldGVyLmFsbFByb2R1Y3RzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgICB2YXIgbWF4ID0gdGhpcy51bmxvYWRTaG9wQW1vdW50W3hdO1xuICAgICAgICAgICAgaWYgKG1heCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gTWF0aC5taW4obWF4LCB0aGlzLmFpcnBsYW5lLnByb2R1Y3RzW3hdKTtcbiAgICAgICAgICAgICAgICBpZiAobWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkaWZmID0gY2l0eS5zaG9wcyAqIHBhcmFtZXRlci5jYXBhY2l0eVNob3AgLSBjaXR5LmdldENvbXBsZXRlQW1vdW50KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKGRpZmY+MClcbiAgICAgICAgICAgICAgICAgICAgICAgIG1heD1NYXRoLm1pbihtYXgsIGRpZmYpO1xuICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgbWF4PTA7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gLT0gbWF4O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcnBsYW5lLnJlZnJlc2hMb2FkZWRDb3VudCgpO1xuICAgICAgICAgICAgICAgICAgICBjaXR5LnNob3BbeF0gKz0gbWF4O1xuICAgICAgICAgICAgICAgICAgICBkaWZmID0gY2l0eS5zaG9wcyAqIHBhcmFtZXRlci5jYXBhY2l0eVNob3AgLSBjaXR5LmdldENvbXBsZXRlQW1vdW50KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKGRpZmY8PTApe1xuICAgICAgICAgICAgICAgICAgICAgICAgY2l0eS5kb21TaG9wZnVsbC5zdHlsZS5kaXNwbGF5ID0gXCJpbml0aWFsXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgbG9hZFNob3AoKSB7XG4gICAgICAgIHZhciBjaXR5ID0gdGhpcy5haXJwbGFuZS53b3JsZC5jaXRpZXNbdGhpcy5jaXR5aWRdO1xuICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHBhcmFtZXRlci5hbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdmFyIG1heCA9IHRoaXMubG9hZFNob3BVbnRpbEFtb3VudFt4XTtcbiAgICAgICAgICAgIGlmIChtYXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1heCA9IHRoaXMubG9hZFNob3BBbW91bnRbeF07XG4gICAgICAgICAgICAgICAgaWYgKG1heCAmJiBtYXggPiBjaXR5LnNob3BbeF0pXG4gICAgICAgICAgICAgICAgICAgIG1heCA9IGNpdHkuc2hvcFt4XTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gY2l0eS5zaG9wW3hdIC0gdGhpcy5sb2FkU2hvcFVudGlsQW1vdW50W3hdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1heCA8IDApXG4gICAgICAgICAgICAgICAgbWF4ID0gMDtcbiAgICAgICAgICAgIGlmICh0aGlzLm1heExvYWQgIT09IHVuZGVmaW5lZCYmbWF4IT09dW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gTWF0aC5taW4odGhpcy5tYXhMb2FkIC0gdGhpcy5haXJwbGFuZS5wcm9kdWN0c1t4XSxtYXgpO1xuICAgICAgICAgICAgICAgIGlmIChtYXggPCAwKVxuICAgICAgICAgICAgICAgICAgICBtYXggPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1heCAmJiBjaXR5LnNob3BNaW5TdG9ja1t4XSkge1xuICAgICAgICAgICAgICAgIGlmIChjaXR5LnNob3BbeF0gLSBtYXggPCBjaXR5LnNob3BNaW5TdG9ja1t4XSkge1xuICAgICAgICAgICAgICAgICAgICBtYXggPSBjaXR5LnNob3BbeF0gLSBjaXR5LnNob3BNaW5TdG9ja1t4XTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1heCA8IDApXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtYXggJiYgbWF4ID4gKHRoaXMuYWlycGxhbmUuY2FwYWNpdHkgLSB0aGlzLmFpcnBsYW5lLmxvYWRlZENvdW50KSlcbiAgICAgICAgICAgICAgICBtYXggPSB0aGlzLmFpcnBsYW5lLmNhcGFjaXR5IC0gdGhpcy5haXJwbGFuZS5sb2FkZWRDb3VudDtcblxuICAgICAgICAgICAgaWYgKG1heCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gKz0gbWF4O1xuICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucmVmcmVzaExvYWRlZENvdW50KCk7XG4gICAgICAgICAgICAgICAgY2l0eS5zaG9wW3hdIC09IG1heDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgfVxuICAgIGxvYWRNYXJrZXQoKSB7XG4gICAgICAgIHZhciBjaXR5ID0gdGhpcy5haXJwbGFuZS53b3JsZC5jaXRpZXNbdGhpcy5jaXR5aWRdO1xuICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHBhcmFtZXRlci5hbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdmFyIG1heCA9IHRoaXMubG9hZE1hcmtldEFtb3VudFt4XTtcbiAgICAgICAgICAgIGlmICh0aGlzLm1heExvYWQgIT09IHVuZGVmaW5lZCYmbWF4KSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gTWF0aC5taW4obWF4LHRoaXMubWF4TG9hZCAtIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0pO1xuICAgICAgICAgICAgICAgIGlmIChtYXggPCAwKVxuICAgICAgICAgICAgICAgICAgICBtYXggPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1heCAmJiBtYXggPiAodGhpcy5haXJwbGFuZS5jYXBhY2l0eSAtIHRoaXMuYWlycGxhbmUubG9hZGVkQ291bnQpKVxuICAgICAgICAgICAgICAgIG1heCA9IHRoaXMuYWlycGxhbmUuY2FwYWNpdHkgLSB0aGlzLmFpcnBsYW5lLmxvYWRlZENvdW50O1xuICAgICAgICAgICAgaWYgKG1heCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgbWF4OyB5KyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByaWNlID0gcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3hdLmNhbGNQcmljZShjaXR5LnBlb3BsZSwgY2l0eS5tYXJrZXRbeF0gLSAxLCBjaXR5LmlzUHJvZHVjZWRIZXJlKHgpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByaWNlIDw9IHRoaXMubG9hZE1hcmtldFByaWNlW3hdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaXR5LndvcmxkLmdhbWUuY2hhbmdlTW9uZXkoLTEgKiBwcmljZSwgXCJhaXJwbGFuZSBidXlzIGZyb20gbWFya2V0XCIsIGNpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2l0eS5tYXJrZXRbeF0gLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucmVmcmVzaExvYWRlZENvdW50KCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgbG9hZCgpIHtcbiAgICAgICAgdGhpcy5sb2FkU2hvcCgpO1xuICAgICAgICB0aGlzLmxvYWRNYXJrZXQoKTtcbiAgICB9XG4gICAgdW5sb2FkKCkge1xuXG4gICAgICAgIHRoaXMudW5sb2FkTWFya2V0KCk7XG4gICAgICAgIHRoaXMudW5sb2FkU2hvcCgpO1xuICAgIH1cbn0iXX0=