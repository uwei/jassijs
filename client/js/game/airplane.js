define(["require", "exports", "game/product", "game/airplanedialog"], function (require, exports, product_1, airplanedialog_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Airplane = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    //
    class Airplane {
        constructor(world) {
            this.status = "";
            this.activeRoute = 0;
            this.type = "Airplane";
            this.world = world;
            this.route = [];
            /*  for(var x=0;x<4;x++){
                  var rt=new Route();
                  rt.cityid=x;
                  this.route.push(rt);
              }*/
        }
        render() {
            var _this = this;
            this.dom = document.createRange().createContextualFragment("<span style='font-size:20px;transform:rotate(0turn)' class='mdi mdi-airplane'></span>").children[0]; //document.createElement("span");
            this.dom.style.position = "absolute";
            this.action = "wait";
            this.products = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.products[x] = 0;
            }
            this.dom.addEventListener("click", (ev) => {
                _this.onclick(ev);
                return undefined;
            });
            this.lastUpdate = this.world.game.date.getTime();
            this.update();
        }
        flyTo(city) {
            var x = city.x;
            var y = city.y;
            this.lastUpdate = this.world.game.date.getTime();
            // console.log("fly to " + city.name)
            this.action = "fly";
            this.status = "fly to " + city.name;
            this.targetX = x;
            this.targetY = y;
            this.update();
            for (var i = 0; i < this.world.cities.length; i++) {
                var pos = this.world.cities[i].airplanesInCity.indexOf(this);
                if (pos !== -1) {
                    this.world.cities[i].airplanesInCity.splice(pos, 1);
                }
            }
        }
        select() {
            var _a;
            (_a = this.dom) === null || _a === void 0 ? void 0 : _a.style.color = "red";
        }
        unselect() {
            var _a;
            (_a = this.dom) === null || _a === void 0 ? void 0 : _a.style.color = "black";
        }
        arrived() {
            var _a;
            console.log("target arrived");
            this.targetX = undefined;
            this.targetY = undefined;
            this.action = "wait";
            this.status = "";
            (_a = this.world.findCityAt(this.x, this.y)) === null || _a === void 0 ? void 0 : _a.airplanesInCity.push(this);
            this.dom.style.transform = "rotate(0deg)";
            if (this.activeRoute !== -1) {
                console.log("unload now");
                this.action = "unload";
                this.status = "unload";
                this.lastAction = this.lastUpdate;
            }
        }
        calcNewPosition() {
            var pixelToTarget = Math.round(Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2))); //Pytharoras
            var fromX = this.x;
            var fromY = this.y;
            var fromTime = 0;
            var toX = this.targetX;
            var toY = this.targetY;
            var toTime = pixelToTarget / this.speed; //t=s/v; in Tage
            var speedVectorX = toX - fromX;
            var speedVectorY = toY - fromY;
            var speedVectorTime = (toTime - fromTime);
            var nowTime = (this.world.game.date.getTime() - this.lastUpdate) / (1000 * 60 * 60 * 24);
            var nowX = Math.round((nowTime / speedVectorTime) * speedVectorX + fromX);
            var nowY = Math.round((nowTime / speedVectorTime) * speedVectorY + fromY);
            if (nowTime >= toTime) {
                this.x = this.targetX;
                this.y = this.targetY;
                this.arrived();
            }
            else {
                var rad = Math.atan((fromX - toX) / (fromY - toY));
                var winkel = 0;
                if (fromY > toY) {
                    winkel = 360 - rad * (180) / Math.PI;
                }
                else {
                    winkel = 180 - rad * (180) / Math.PI;
                }
                var s = ("" + winkel).replace(",", ".");
                this.dom.style.transform = "rotate(" + s + "deg)";
                // console.log(pixelToTarget+" pixel in "+toTime+" seconds. Position "+nowX+" "+nowY+" lastupdate "+nowTime+" "+winkel+"Â°");
                this.x = nowX;
                this.y = nowY;
            }
        }
        update() {
            if (this.targetX !== undefined) {
                this.calcNewPosition();
            }
            this.lastUpdate = this.world.game.date.getTime();
            this.dom.style.top = this.y + "px";
            this.dom.style.left = (this.x - 15) + "px";
            if (this.activeRoute !== -1 && this.route.length > 1) {
                if (this.action === "unload" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    // console.log("load now");
                    this.action = "load";
                    this.status = "load";
                    this.lastAction = this.lastUpdate;
                    this.route[this.activeRoute].unload();
                    airplanedialog_1.AirplaneDialog.getInstance().update();
                }
                if (this.action === "load" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    this.lastAction = this.lastUpdate;
                    this.route[this.activeRoute].load();
                    airplanedialog_1.AirplaneDialog.getInstance().update();
                    this.activeRoute++;
                    if (this.activeRoute === this.route.length)
                        this.activeRoute = 0;
                    var city = this.world.cities[this.route[this.activeRoute].cityid];
                    this.flyTo(city);
                }
            }
        }
        onclick(th) {
            var _a;
            th.preventDefault();
            th.stopPropagation();
            console.log(this.name);
            (_a = this.world.selection) === null || _a === void 0 ? void 0 : _a.unselect();
            this.world.selection = this;
            this.select();
            var h = airplanedialog_1.AirplaneDialog.getInstance();
            h.airplane = this;
            h.show();
        }
    }
    exports.Airplane = Airplane;
});
//<span style='font-size:100px;'>&#9951;</span>
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlycGxhbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL2FpcnBsYW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFNQSxTQUFTLFlBQVksQ0FBQyxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUNELEVBQUU7SUFDRixNQUFhLFFBQVE7UUFrQmpCLFlBQVksS0FBWTtZQUp4QixXQUFNLEdBQVcsRUFBRSxDQUFDO1lBRXBCLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLFNBQUksR0FBQyxVQUFVLENBQUM7WUFFWixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNoQjs7OztpQkFJSztRQUNULENBQUM7UUFDRCxNQUFNO1lBQ0YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQVEsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLHdCQUF3QixDQUFDLHVGQUF1RixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEsaUNBQWlDO1lBQ3RNLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFFckMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHFCQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUV4QjtZQUNELElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBYyxFQUFFLEVBQUU7Z0JBQ2xELEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xCLE9BQU8sU0FBUyxDQUFDO1lBQ3JCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDakQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRWxCLENBQUM7UUFFRCxLQUFLLENBQUMsSUFBUztZQUNYLElBQUksQ0FBQyxHQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDYixJQUFJLENBQUMsR0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRWIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbEQscUNBQXFDO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUMsU0FBUyxHQUFFLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7WUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7WUFDakIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2QsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDL0MsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDN0QsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLEVBQUU7b0JBQ1osSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZEO2FBQ0o7UUFDTCxDQUFDO1FBQ0QsTUFBTTs7WUFDRixNQUFBLElBQUksQ0FBQyxHQUFHLDBDQUFFLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ2xDLENBQUM7UUFDRCxRQUFROztZQUNKLE1BQUEsSUFBSSxDQUFDLEdBQUcsMENBQUUsS0FBSyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUM7UUFDcEMsQ0FBQztRQUNELE9BQU87O1lBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQ2pCLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLDBDQUFFLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLGNBQWMsQ0FBQztZQUMxQyxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDO2dCQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO2FBQ3JDO1FBQ0wsQ0FBQztRQUNELGVBQWU7WUFDWCxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEsWUFBWTtZQUMvSCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDdkIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUN2QixJQUFJLE1BQU0sR0FBRyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFJLGdCQUFnQjtZQUM1RCxJQUFJLFlBQVksR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDO1lBQy9CLElBQUksWUFBWSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUM7WUFDL0IsSUFBSSxlQUFlLEdBQUcsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUM7WUFDMUMsSUFBSSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDekYsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUMsR0FBRyxZQUFZLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDMUUsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUMsR0FBRyxZQUFZLEdBQUcsS0FBSyxDQUFDLENBQUM7WUFDMUUsSUFBSSxPQUFPLElBQUksTUFBTSxFQUFFO2dCQUNuQixJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDdEIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQ2xCO2lCQUFNO2dCQUNILElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDbkQsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNmLElBQUksS0FBSyxHQUFHLEdBQUcsRUFBRTtvQkFDYixNQUFNLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7aUJBQ3hDO3FCQUFNO29CQUNILE1BQU0sR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztpQkFDeEM7Z0JBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLFNBQVMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDO2dCQUNsRCw0SEFBNEg7Z0JBQzVILElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUNkLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ2pCO1FBQ0wsQ0FBQztRQUNELE1BQU07WUFFRixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssU0FBUyxFQUFFO2dCQUM1QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7YUFDMUI7WUFDRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDbkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDM0MsSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLENBQUMsQ0FBQyxJQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFDLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFHLFFBQVEsSUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBQyxFQUFFLEdBQUMsRUFBRSxDQUFDLEVBQUU7b0JBQ2pGLDJCQUEyQjtvQkFDMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7b0JBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO29CQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUN0QywrQkFBYyxDQUFDLFdBQVcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUN6QztnQkFDRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUcsTUFBTSxJQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFDLEVBQUUsR0FBQyxFQUFFLENBQUMsRUFBRTtvQkFFOUUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO29CQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDcEMsK0JBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDekMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUNoQixJQUFHLElBQUksQ0FBQyxXQUFXLEtBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO3dCQUNuQyxJQUFJLENBQUMsV0FBVyxHQUFDLENBQUMsQ0FBQztvQkFDdkIsSUFBSSxJQUFJLEdBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ2hFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBRXBCO2FBQ0o7UUFDTCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEVBQWM7O1lBQ2xCLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNwQixFQUFFLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkIsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsMENBQUUsUUFBUSxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNkLElBQUksQ0FBQyxHQUFHLCtCQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWIsQ0FBQztLQUNKO0lBbEtELDRCQWtLQzs7QUFFRCwrQ0FBK0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBXb3JsZCB9IGZyb20gXCJnYW1lL3dvcmxkXCI7XG5pbXBvcnQgeyBhbGxQcm9kdWN0cyB9IGZyb20gXCJnYW1lL3Byb2R1Y3RcIjtcbmltcG9ydCB7IEFpcnBsYW5lRGlhbG9nIH0gZnJvbSBcImdhbWUvYWlycGxhbmVkaWFsb2dcIjtcbmltcG9ydCB7IFJvdXRlIH0gZnJvbSBcImdhbWUvcm91dGVcIjtcbmltcG9ydCB7IENpdHkgfSBmcm9tIFwiZ2FtZS9jaXR5XCI7XG5cbmZ1bmN0aW9uIGdldFJhbmRvbUludChtYXgpIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbWF4KTtcbn1cbi8vXG5leHBvcnQgY2xhc3MgQWlycGxhbmUge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBhY3Rpb246IHN0cmluZztcbiAgICBsYXN0QWN0aW9uOiBudW1iZXI7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbiAgICAvL3BpeGVsIHBybyBzZWNvbmRcbiAgICBzcGVlZDogbnVtYmVyO1xuICAgIGxhc3RVcGRhdGU6IG51bWJlcjtcbiAgICB0YXJnZXRYOiBudW1iZXI7XG4gICAgdGFyZ2V0WTogbnVtYmVyO1xuICAgIGRvbTogSFRNTFNwYW5FbGVtZW50O1xuICAgIHdvcmxkOiBXb3JsZDtcbiAgICBwcm9kdWN0cztcbiAgICBzdGF0dXM6IHN0cmluZyA9IFwiXCI7XG4gICAgcm91dGU6IFJvdXRlW107XG4gICAgYWN0aXZlUm91dGUgPSAwO1xuICAgIHR5cGU9XCJBaXJwbGFuZVwiO1xuICAgIGNvbnN0cnVjdG9yKHdvcmxkOiBXb3JsZCkge1xuICAgICAgICB0aGlzLndvcmxkID0gd29ybGQ7XG4gICAgICAgIHRoaXMucm91dGUgPSBbXTtcbiAgICAgICAgLyogIGZvcih2YXIgeD0wO3g8NDt4Kyspe1xuICAgICAgICAgICAgICB2YXIgcnQ9bmV3IFJvdXRlKCk7XG4gICAgICAgICAgICAgIHJ0LmNpdHlpZD14O1xuICAgICAgICAgICAgICB0aGlzLnJvdXRlLnB1c2gocnQpO1xuICAgICAgICAgIH0qL1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHRoaXMuZG9tID0gPGFueT5kb2N1bWVudC5jcmVhdGVSYW5nZSgpLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudChcIjxzcGFuIHN0eWxlPSdmb250LXNpemU6MjBweDt0cmFuc2Zvcm06cm90YXRlKDB0dXJuKScgY2xhc3M9J21kaSBtZGktYWlycGxhbmUnPjwvc3Bhbj5cIikuY2hpbGRyZW5bMF07Ly9kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgICBcbiAgICAgICAgdGhpcy5hY3Rpb24gPSBcIndhaXRcIjtcbiAgICAgICAgdGhpcy5wcm9kdWN0cyA9IFtdO1xuICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFsbFByb2R1Y3RzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgICB0aGlzLnByb2R1Y3RzW3hdID0gMDtcblxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZG9tLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIF90aGlzLm9uY2xpY2soZXYpO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubGFzdFVwZGF0ZSA9IHRoaXMud29ybGQuZ2FtZS5kYXRlLmdldFRpbWUoKTtcbiAgICAgICAgdGhpcy51cGRhdGUoKTtcblxuICAgIH1cblxuICAgIGZseVRvKGNpdHk6Q2l0eSkge1xuICAgICAgICB2YXIgeD1jaXR5Lng7XG4gICAgICAgIHZhciB5PWNpdHkueTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMubGFzdFVwZGF0ZSA9IHRoaXMud29ybGQuZ2FtZS5kYXRlLmdldFRpbWUoKTtcbiAgICAgICAvLyBjb25zb2xlLmxvZyhcImZseSB0byBcIiArIGNpdHkubmFtZSlcbiAgICAgICAgdGhpcy5hY3Rpb24gPSBcImZseVwiO1xuICAgICAgICB0aGlzLnN0YXR1cz1cImZseSB0byBcIisgY2l0eS5uYW1lO1xuICAgICAgICB0aGlzLnRhcmdldFggPSB4O1xuICAgICAgICB0aGlzLnRhcmdldFkgPSB5O1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMud29ybGQuY2l0aWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgcG9zID0gdGhpcy53b3JsZC5jaXRpZXNbaV0uYWlycGxhbmVzSW5DaXR5LmluZGV4T2YodGhpcyk7XG4gICAgICAgICAgICBpZiAocG9zICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMud29ybGQuY2l0aWVzW2ldLmFpcnBsYW5lc0luQ2l0eS5zcGxpY2UocG9zLCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWxlY3QoKSB7XG4gICAgICAgIHRoaXMuZG9tPy5zdHlsZS5jb2xvciA9IFwicmVkXCI7XG4gICAgfVxuICAgIHVuc2VsZWN0KCkge1xuICAgICAgICB0aGlzLmRvbT8uc3R5bGUuY29sb3IgPSBcImJsYWNrXCI7XG4gICAgfVxuICAgIGFycml2ZWQoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGFyZ2V0IGFycml2ZWRcIik7XG4gICAgICAgIHRoaXMudGFyZ2V0WCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy50YXJnZXRZID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFjdGlvbiA9IFwid2FpdFwiO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IFwiXCI7XG4gICAgICAgIHRoaXMud29ybGQuZmluZENpdHlBdCh0aGlzLngsIHRoaXMueSk/LmFpcnBsYW5lc0luQ2l0eS5wdXNoKHRoaXMpO1xuICAgICAgICB0aGlzLmRvbS5zdHlsZS50cmFuc2Zvcm0gPSBcInJvdGF0ZSgwZGVnKVwiO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVSb3V0ZSAhPT0gLTEpIHtcbiAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInVubG9hZCBub3dcIik7XG4gICAgICAgICAgICB0aGlzLmFjdGlvbiA9IFwidW5sb2FkXCI7XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwidW5sb2FkXCI7XG4gICAgICAgICAgICB0aGlzLmxhc3RBY3Rpb24gPSB0aGlzLmxhc3RVcGRhdGU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2FsY05ld1Bvc2l0aW9uKCkge1xuICAgICAgICB2YXIgcGl4ZWxUb1RhcmdldCA9IE1hdGgucm91bmQoTWF0aC5zcXJ0KE1hdGgucG93KHRoaXMudGFyZ2V0WCAtIHRoaXMueCwgMikgKyBNYXRoLnBvdyh0aGlzLnRhcmdldFkgLSB0aGlzLnksIDIpKSk7Ly9QeXRoYXJvcmFzXG4gICAgICAgIHZhciBmcm9tWCA9IHRoaXMueDtcbiAgICAgICAgdmFyIGZyb21ZID0gdGhpcy55O1xuICAgICAgICB2YXIgZnJvbVRpbWUgPSAwO1xuICAgICAgICB2YXIgdG9YID0gdGhpcy50YXJnZXRYO1xuICAgICAgICB2YXIgdG9ZID0gdGhpcy50YXJnZXRZO1xuICAgICAgICB2YXIgdG9UaW1lID0gcGl4ZWxUb1RhcmdldCAvIHRoaXMuc3BlZWQ7ICAgIC8vdD1zL3Y7IGluIFRhZ2VcbiAgICAgICAgdmFyIHNwZWVkVmVjdG9yWCA9IHRvWCAtIGZyb21YO1xuICAgICAgICB2YXIgc3BlZWRWZWN0b3JZID0gdG9ZIC0gZnJvbVk7XG4gICAgICAgIHZhciBzcGVlZFZlY3RvclRpbWUgPSAodG9UaW1lIC0gZnJvbVRpbWUpO1xuICAgICAgICB2YXIgbm93VGltZSA9ICh0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCkgLSB0aGlzLmxhc3RVcGRhdGUpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuICAgICAgICB2YXIgbm93WCA9IE1hdGgucm91bmQoKG5vd1RpbWUgLyBzcGVlZFZlY3RvclRpbWUpICogc3BlZWRWZWN0b3JYICsgZnJvbVgpO1xuICAgICAgICB2YXIgbm93WSA9IE1hdGgucm91bmQoKG5vd1RpbWUgLyBzcGVlZFZlY3RvclRpbWUpICogc3BlZWRWZWN0b3JZICsgZnJvbVkpO1xuICAgICAgICBpZiAobm93VGltZSA+PSB0b1RpbWUpIHtcbiAgICAgICAgICAgIHRoaXMueCA9IHRoaXMudGFyZ2V0WDtcbiAgICAgICAgICAgIHRoaXMueSA9IHRoaXMudGFyZ2V0WTtcbiAgICAgICAgICAgIHRoaXMuYXJyaXZlZCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIHJhZCA9IE1hdGguYXRhbigoZnJvbVggLSB0b1gpIC8gKGZyb21ZIC0gdG9ZKSk7XG4gICAgICAgICAgICB2YXIgd2lua2VsID0gMDtcbiAgICAgICAgICAgIGlmIChmcm9tWSA+IHRvWSkge1xuICAgICAgICAgICAgICAgIHdpbmtlbCA9IDM2MCAtIHJhZCAqICgxODApIC8gTWF0aC5QSTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2lua2VsID0gMTgwIC0gcmFkICogKDE4MCkgLyBNYXRoLlBJO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHMgPSAoXCJcIiArIHdpbmtlbCkucmVwbGFjZShcIixcIiwgXCIuXCIpO1xuICAgICAgICAgICAgdGhpcy5kb20uc3R5bGUudHJhbnNmb3JtID0gXCJyb3RhdGUoXCIgKyBzICsgXCJkZWcpXCI7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhwaXhlbFRvVGFyZ2V0K1wiIHBpeGVsIGluIFwiK3RvVGltZStcIiBzZWNvbmRzLiBQb3NpdGlvbiBcIitub3dYK1wiIFwiK25vd1krXCIgbGFzdHVwZGF0ZSBcIitub3dUaW1lK1wiIFwiK3dpbmtlbCtcIsKwXCIpO1xuICAgICAgICAgICAgdGhpcy54ID0gbm93WDtcbiAgICAgICAgICAgIHRoaXMueSA9IG5vd1k7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdXBkYXRlKCkge1xuXG4gICAgICAgIGlmICh0aGlzLnRhcmdldFggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5jYWxjTmV3UG9zaXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLnRvcCA9IHRoaXMueSArIFwicHhcIjtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUubGVmdCA9ICh0aGlzLnggLSAxNSkgKyBcInB4XCI7XG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZVJvdXRlICE9PSAtMSYmdGhpcy5yb3V0ZS5sZW5ndGg+MSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uPT09XCJ1bmxvYWRcIiYmKHRoaXMubGFzdFVwZGF0ZSAtIHRoaXMubGFzdEFjdGlvbikgPiAoMyAqIDEwMDAqNjAqNjApKSB7XG4gICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcImxvYWQgbm93XCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uID0gXCJsb2FkXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBcImxvYWRcIjtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RBY3Rpb24gPSB0aGlzLmxhc3RVcGRhdGU7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3V0ZVt0aGlzLmFjdGl2ZVJvdXRlXS51bmxvYWQoKTtcbiAgICAgICAgICAgICAgICBBaXJwbGFuZURpYWxvZy5nZXRJbnN0YW5jZSgpLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uPT09XCJsb2FkXCImJih0aGlzLmxhc3RVcGRhdGUgLSB0aGlzLmxhc3RBY3Rpb24pID4gKDMgKiAxMDAwKjYwKjYwKSkge1xuICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICAgICAgICAgIHRoaXMucm91dGVbdGhpcy5hY3RpdmVSb3V0ZV0ubG9hZCgpO1xuICAgICAgICAgICAgICAgIEFpcnBsYW5lRGlhbG9nLmdldEluc3RhbmNlKCkudXBkYXRlKCk7XG4gICAgICAgICAgICAgdGhpcy5hY3RpdmVSb3V0ZSsrO1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuYWN0aXZlUm91dGU9PT10aGlzLnJvdXRlLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVSb3V0ZT0wO1xuICAgICAgICAgICAgICAgIHZhciBjaXR5PXRoaXMud29ybGQuY2l0aWVzW3RoaXMucm91dGVbdGhpcy5hY3RpdmVSb3V0ZV0uY2l0eWlkXTtcbiAgICAgICAgICAgICAgICB0aGlzLmZseVRvKGNpdHkpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIG9uY2xpY2sodGg6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgdGgucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGguc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSk7XG4gICAgICAgIHRoaXMud29ybGQuc2VsZWN0aW9uPy51bnNlbGVjdCgpO1xuICAgICAgICB0aGlzLndvcmxkLnNlbGVjdGlvbiA9IHRoaXM7XG4gICAgICAgIHRoaXMuc2VsZWN0KCk7XG4gICAgICAgIHZhciBoID0gQWlycGxhbmVEaWFsb2cuZ2V0SW5zdGFuY2UoKTtcbiAgICAgICAgaC5haXJwbGFuZSA9IHRoaXM7XG4gICAgICAgIGguc2hvdygpO1xuXG4gICAgfVxufVxuXG4vLzxzcGFuIHN0eWxlPSdmb250LXNpemU6MTAwcHg7Jz4mIzk5NTE7PC9zcGFuPiJdfQ==