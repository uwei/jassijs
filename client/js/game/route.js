define(["require", "exports", "game/product"], function (require, exports, product_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Route = void 0;
    class Route {
        constructor() {
            this.type = "Route";
            this.unloadMarketAmount = [];
            this.unloadMarketPrice = [];
            this.unloadWarehouseAmount = [];
            this.loadMarketAmount = [];
            this.loadMarketUntilAmount = [];
            this.loadMarketPrice = [];
            this.loadWarehouseAmount = [];
            this.loadWarehouseUntilAmount = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.unloadMarketAmount.push(undefined);
                this.unloadMarketPrice.push(product_1.allProducts[x].priceSelling);
                this.unloadWarehouseAmount.push(undefined);
                this.loadMarketAmount.push(undefined);
                this.loadMarketUntilAmount.push(undefined);
                this.loadMarketPrice.push(product_1.allProducts[x].pricePurchase);
                this.loadWarehouseAmount.push(undefined);
                this.loadWarehouseUntilAmount.push(undefined);
            }
        }
        unloadMarket() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                var max = this.airplane.products[x];
                if (this.unloadMarketAmount[x] !== undefined) {
                    max = Math.min(this.airplane.products[x], this.unloadMarketAmount[x]);
                    if (max < 0)
                        max = 0;
                }
                else
                    max = 0;
                if (max) {
                    for (var y = 0; y < max; y++) {
                        var price = product_1.allProducts[x].calcPrice(city.people, city.market[x], false); //city.isProducedHere(x));
                        if (price >= this.unloadMarketPrice[x]) {
                            city.world.game.changeMoney(1 * price, "airplane sells from market", city);
                            city.market[x] += 1;
                            this.airplane.products[x] -= 1;
                            this.airplane.refreshLoadedCount();
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        unloadWarehouse() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                var max = this.unloadWarehouseAmount[x];
                if (max !== undefined) {
                    max = Math.min(max, this.airplane.products[x]);
                    if (max) {
                        this.airplane.products[x] -= max;
                        this.airplane.refreshLoadedCount();
                        city.warehouse[x] += max;
                    }
                }
            }
        }
        loadWarehouse() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                var max = this.loadWarehouseUntilAmount[x];
                if (max === undefined) {
                    max = this.loadWarehouseAmount[x];
                    if (max && max > city.warehouse[x])
                        max = city.warehouse[x];
                }
                else {
                    max = city.warehouse[x] - this.loadWarehouseUntilAmount[x];
                }
                if (max < 0)
                    max = 0;
                if (max && city.warehouseMinStock[x]) {
                    if (city.warehouse[x] - max < city.warehouseMinStock[x]) {
                        max = city.warehouse[x] - city.warehouseMinStock[x];
                        if (max < 0)
                            max = 0;
                    }
                }
                if (max && max > (this.airplane.capacity - this.airplane.loadedCount))
                    max = this.airplane.capacity - this.airplane.loadedCount;
                if (max) {
                    this.airplane.products[x] += max;
                    this.airplane.refreshLoadedCount();
                    city.warehouse[x] -= max;
                }
            }
        }
        loadMarket() {
            var city = this.airplane.world.cities[this.cityid];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                var max = this.loadMarketAmount[x];
                if (this.loadMarketUntilAmount[x] !== undefined) {
                    max = this.loadMarketUntilAmount[x] - this.airplane.products[x];
                    if (max < 0)
                        max = 0;
                }
                if (max && max > (this.airplane.capacity - this.airplane.loadedCount))
                    max = this.airplane.capacity - this.airplane.loadedCount;
                if (max) {
                    for (var y = 0; y < max; y++) {
                        var price = product_1.allProducts[x].calcPrice(city.people, city.market[x] - 1, city.isProducedHere(x));
                        if (price <= this.loadMarketPrice[x]) {
                            city.world.game.changeMoney(-1 * price, "airplane buys from market", city);
                            city.market[x] -= 1;
                            this.airplane.products[x] += 1;
                            this.airplane.refreshLoadedCount();
                        }
                        else {
                            break;
                        }
                    }
                }
            }
        }
        load() {
            this.loadWarehouse();
            this.loadMarket();
        }
        unload() {
            this.unloadMarket();
            this.unloadWarehouse();
        }
    }
    exports.Route = Route;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL3JvdXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFHQSxNQUFhLEtBQUs7UUFZZDtZQURBLFNBQUksR0FBRyxPQUFPLENBQUM7WUFFWCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUM7WUFDaEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztZQUM5QixJQUFJLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFDO1lBQ25DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxxQkFBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxxQkFBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN0QyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxxQkFBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFB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QUFDO1FBQzNCLENBQUM7S0FDSjtJQTlJRCxzQkE4SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBaXJwbGFuZSB9IGZyb20gXCJnYW1lL2FpcnBsYW5lXCI7XG5pbXBvcnQgeyBhbGxQcm9kdWN0cyB9IGZyb20gXCJnYW1lL3Byb2R1Y3RcIjtcblxuZXhwb3J0IGNsYXNzIFJvdXRlIHtcbiAgICBjaXR5aWQ6IG51bWJlcjtcbiAgICB1bmxvYWRNYXJrZXRBbW91bnQ6IG51bWJlcltdO1xuICAgIHVubG9hZE1hcmtldFByaWNlOiBudW1iZXJbXTtcbiAgICB1bmxvYWRXYXJlaG91c2VBbW91bnQ6IG51bWJlcltdO1xuICAgIGxvYWRNYXJrZXRBbW91bnQ6IG51bWJlcltdO1xuICAgIGxvYWRNYXJrZXRVbnRpbEFtb3VudDogbnVtYmVyW107XG4gICAgbG9hZE1hcmtldFByaWNlOiBudW1iZXJbXTtcbiAgICBsb2FkV2FyZWhvdXNlQW1vdW50OiBudW1iZXJbXTtcbiAgICBsb2FkV2FyZWhvdXNlVW50aWxBbW91bnQ6IG51bWJlcltdO1xuICAgIGFpcnBsYW5lOiBBaXJwbGFuZTtcbiAgICB0eXBlID0gXCJSb3V0ZVwiO1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnVubG9hZE1hcmtldEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLnVubG9hZE1hcmtldFByaWNlID0gW107XG4gICAgICAgIHRoaXMudW5sb2FkV2FyZWhvdXNlQW1vdW50ID0gW107XG4gICAgICAgIHRoaXMubG9hZE1hcmtldEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLmxvYWRNYXJrZXRVbnRpbEFtb3VudCA9IFtdO1xuICAgICAgICB0aGlzLmxvYWRNYXJrZXRQcmljZSA9IFtdO1xuICAgICAgICB0aGlzLmxvYWRXYXJlaG91c2VBbW91bnQgPSBbXTtcbiAgICAgICAgdGhpcy5sb2FkV2FyZWhvdXNlVW50aWxBbW91bnQgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBhbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdGhpcy51bmxvYWRNYXJrZXRBbW91bnQucHVzaCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgdGhpcy51bmxvYWRNYXJrZXRQcmljZS5wdXNoKGFsbFByb2R1Y3RzW3hdLnByaWNlU2VsbGluZyk7XG4gICAgICAgICAgICB0aGlzLnVubG9hZFdhcmVob3VzZUFtb3VudC5wdXNoKHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRNYXJrZXRBbW91bnQucHVzaCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgdGhpcy5sb2FkTWFya2V0VW50aWxBbW91bnQucHVzaCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgdGhpcy5sb2FkTWFya2V0UHJpY2UucHVzaChhbGxQcm9kdWN0c1t4XS5wcmljZVB1cmNoYXNlKTtcbiAgICAgICAgICAgIHRoaXMubG9hZFdhcmVob3VzZUFtb3VudC5wdXNoKHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB0aGlzLmxvYWRXYXJlaG91c2VVbnRpbEFtb3VudC5wdXNoKHVuZGVmaW5lZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdW5sb2FkTWFya2V0KCkge1xuICAgICAgICB2YXIgY2l0eSA9IHRoaXMuYWlycGxhbmUud29ybGQuY2l0aWVzW3RoaXMuY2l0eWlkXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBhbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdmFyIG1heCA9IHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF07XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnVubG9hZE1hcmtldEFtb3VudFt4XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gTWF0aC5taW4odGhpcy5haXJwbGFuZS5wcm9kdWN0c1t4XSwgdGhpcy51bmxvYWRNYXJrZXRBbW91bnRbeF0pO1xuICAgICAgICAgICAgICAgIGlmIChtYXggPCAwKVxuICAgICAgICAgICAgICAgICAgICBtYXggPSAwO1xuICAgICAgICAgICAgfWVsc2VcbiAgICAgICAgICAgICAgICBtYXg9MDtcbiAgICAgICAgICAgIGlmIChtYXgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IG1heDsgeSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmljZSA9IGFsbFByb2R1Y3RzW3hdLmNhbGNQcmljZShjaXR5LnBlb3BsZSwgY2l0eS5tYXJrZXRbeF0sIGZhbHNlKTsvL2NpdHkuaXNQcm9kdWNlZEhlcmUoeCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJpY2UgPj0gdGhpcy51bmxvYWRNYXJrZXRQcmljZVt4XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2l0eS53b3JsZC5nYW1lLmNoYW5nZU1vbmV5KDEgKiBwcmljZSwgXCJhaXJwbGFuZSBzZWxscyBmcm9tIG1hcmtldFwiLCBjaXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNpdHkubWFya2V0W3hdICs9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcnBsYW5lLnByb2R1Y3RzW3hdIC09IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcnBsYW5lLnJlZnJlc2hMb2FkZWRDb3VudCgpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHVubG9hZFdhcmVob3VzZSgpIHtcbiAgICAgICAgdmFyIGNpdHkgPSB0aGlzLmFpcnBsYW5lLndvcmxkLmNpdGllc1t0aGlzLmNpdHlpZF07XG4gICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIHZhciBtYXggPSB0aGlzLnVubG9hZFdhcmVob3VzZUFtb3VudFt4XTtcbiAgICAgICAgICAgIGlmIChtYXggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1heCA9IE1hdGgubWluKG1heCwgdGhpcy5haXJwbGFuZS5wcm9kdWN0c1t4XSk7XG4gICAgICAgICAgICAgICAgaWYgKG1heCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFpcnBsYW5lLnByb2R1Y3RzW3hdIC09IG1heDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5haXJwbGFuZS5yZWZyZXNoTG9hZGVkQ291bnQoKTtcbiAgICAgICAgICAgICAgICAgICAgY2l0eS53YXJlaG91c2VbeF0gKz0gbWF4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBsb2FkV2FyZWhvdXNlKCkge1xuICAgICAgICB2YXIgY2l0eSA9IHRoaXMuYWlycGxhbmUud29ybGQuY2l0aWVzW3RoaXMuY2l0eWlkXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBhbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdmFyIG1heCA9IHRoaXMubG9hZFdhcmVob3VzZVVudGlsQW1vdW50W3hdO1xuICAgICAgICAgICAgaWYgKG1heCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgbWF4ID0gdGhpcy5sb2FkV2FyZWhvdXNlQW1vdW50W3hdO1xuICAgICAgICAgICAgICAgIGlmIChtYXggJiYgbWF4ID4gY2l0eS53YXJlaG91c2VbeF0pXG4gICAgICAgICAgICAgICAgICAgIG1heCA9IGNpdHkud2FyZWhvdXNlW3hdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtYXggPSBjaXR5LndhcmVob3VzZVt4XS10aGlzLmxvYWRXYXJlaG91c2VVbnRpbEFtb3VudFt4XTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChtYXggPCAwKVxuICAgICAgICAgICAgICAgIG1heCA9IDA7XG4gICAgICAgICAgICBpZiAobWF4ICYmIGNpdHkud2FyZWhvdXNlTWluU3RvY2tbeF0pIHtcbiAgICAgICAgICAgICAgICBpZiAoY2l0eS53YXJlaG91c2VbeF0gLSBtYXggPCBjaXR5LndhcmVob3VzZU1pblN0b2NrW3hdKSB7XG4gICAgICAgICAgICAgICAgICAgIG1heCA9IGNpdHkud2FyZWhvdXNlW3hdIC0gY2l0eS53YXJlaG91c2VNaW5TdG9ja1t4XTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1heCA8IDApXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtYXggJiYgbWF4ID4gKHRoaXMuYWlycGxhbmUuY2FwYWNpdHkgLSB0aGlzLmFpcnBsYW5lLmxvYWRlZENvdW50KSlcbiAgICAgICAgICAgICAgICBtYXggPSB0aGlzLmFpcnBsYW5lLmNhcGFjaXR5IC0gdGhpcy5haXJwbGFuZS5sb2FkZWRDb3VudDtcblxuICAgICAgICAgICAgaWYgKG1heCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gKz0gbWF4O1xuICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucmVmcmVzaExvYWRlZENvdW50KCk7XG4gICAgICAgICAgICAgICAgY2l0eS53YXJlaG91c2VbeF0gLT0gbWF4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICB9XG4gICAgbG9hZE1hcmtldCgpIHtcbiAgICAgICAgdmFyIGNpdHkgPSB0aGlzLmFpcnBsYW5lLndvcmxkLmNpdGllc1t0aGlzLmNpdHlpZF07XG4gICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIHZhciBtYXggPSB0aGlzLmxvYWRNYXJrZXRBbW91bnRbeF07XG4gICAgICAgICAgICBpZiAodGhpcy5sb2FkTWFya2V0VW50aWxBbW91bnRbeF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG1heCA9IHRoaXMubG9hZE1hcmtldFVudGlsQW1vdW50W3hdIC0gdGhpcy5haXJwbGFuZS5wcm9kdWN0c1t4XTtcbiAgICAgICAgICAgICAgICBpZiAobWF4IDwgMClcbiAgICAgICAgICAgICAgICAgICAgbWF4ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtYXggJiYgbWF4ID4gKHRoaXMuYWlycGxhbmUuY2FwYWNpdHkgLSB0aGlzLmFpcnBsYW5lLmxvYWRlZENvdW50KSlcbiAgICAgICAgICAgICAgICBtYXggPSB0aGlzLmFpcnBsYW5lLmNhcGFjaXR5IC0gdGhpcy5haXJwbGFuZS5sb2FkZWRDb3VudDtcbiAgICAgICAgICAgIGlmIChtYXgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IG1heDsgeSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmljZSA9IGFsbFByb2R1Y3RzW3hdLmNhbGNQcmljZShjaXR5LnBlb3BsZSwgY2l0eS5tYXJrZXRbeF0gLSAxLCBjaXR5LmlzUHJvZHVjZWRIZXJlKHgpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByaWNlIDw9IHRoaXMubG9hZE1hcmtldFByaWNlW3hdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaXR5LndvcmxkLmdhbWUuY2hhbmdlTW9uZXkoLTEgKiBwcmljZSwgXCJhaXJwbGFuZSBidXlzIGZyb20gbWFya2V0XCIsIGNpdHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2l0eS5tYXJrZXRbeF0gLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucHJvZHVjdHNbeF0gKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWlycGxhbmUucmVmcmVzaExvYWRlZENvdW50KCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgbG9hZCgpIHtcbiAgICAgICAgdGhpcy5sb2FkV2FyZWhvdXNlKCk7XG4gICAgICAgIHRoaXMubG9hZE1hcmtldCgpO1xuICAgIH1cbiAgICB1bmxvYWQoKSB7XG5cbiAgICAgICAgdGhpcy51bmxvYWRNYXJrZXQoKTtcbiAgICAgICAgdGhpcy51bmxvYWRXYXJlaG91c2UoKTtcbiAgICB9XG59Il19