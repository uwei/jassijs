define(["require", "exports", "game/product", "game/airplanedialog"], function (require, exports, product_1, airplanedialog_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Airplane = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    class Airplane {
        constructor(world) {
            this.status = "";
            this.activeRoute = 0;
            this.world = world;
            this.route = [];
            /*  for(var x=0;x<4;x++){
                  var rt=new Route();
                  rt.cityid=x;
                  this.route.push(rt);
              }*/
        }
        create() {
            var _this = this;
            this.dom = document.createRange().createContextualFragment("<span style='transform:rotate(0turn)' class='mdi mdi-airplane'></span>").children[0]; //document.createElement("span");
            this.dom.style.position = "absolute";
            this.x = getRandomInt(this.world.game.mapWidth);
            this.y = getRandomInt(this.world.game.mapHeight);
            this.action = "wait";
            this.products = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.products[x] = 0;
            }
            this.dom.addEventListener("click", (ev) => {
                _this.onclick(ev);
                return undefined;
            });
            this.lastUpdate = this.world.game.date.getTime();
            this.update();
        }
        flyTo(city) {
            var x = city.x;
            var y = city.y;
            this.lastUpdate = this.world.game.date.getTime();
            console.log("fly to " + city.name);
            this.action = "fly";
            this.status = "fly to " + city.name;
            this.targetX = x;
            this.targetY = y;
            this.update();
            for (var i = 0; i < this.world.cities.length; i++) {
                var pos = this.world.cities[i].airplanesInCity.indexOf(this);
                if (pos !== -1) {
                    this.world.cities[i].airplanesInCity.splice(pos, 1);
                }
            }
        }
        select() {
            this.dom.style.color = "red";
        }
        unselect() {
            this.dom.style.color = "black";
        }
        arrived() {
            var _a;
            console.log("target arrived");
            this.targetX = undefined;
            this.targetY = undefined;
            this.action = "wait";
            this.status = "";
            (_a = this.world.findCityAt(this.x, this.y)) === null || _a === void 0 ? void 0 : _a.airplanesInCity.push(this);
            this.dom.style.transform = "rotate(0deg)";
            if (this.activeRoute !== -1) {
                console.log("unload now");
                this.action = "unload";
                this.status = "unload";
                this.lastAction = this.lastUpdate;
            }
        }
        calcNewPosition() {
            var pixelToTarget = Math.round(Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2))); //Pytharoras
            var fromX = this.x;
            var fromY = this.y;
            var fromTime = 0;
            var toX = this.targetX;
            var toY = this.targetY;
            var toTime = pixelToTarget / this.speed; //t=s/v; in Tage
            var speedVectorX = toX - fromX;
            var speedVectorY = toY - fromY;
            var speedVectorTime = (toTime - fromTime);
            var nowTime = (this.world.game.date.getTime() - this.lastUpdate) / (1000 * 60 * 60 * 24);
            var nowX = Math.round((nowTime / speedVectorTime) * speedVectorX + fromX);
            var nowY = Math.round((nowTime / speedVectorTime) * speedVectorY + fromY);
            if (nowTime >= toTime) {
                this.x = this.targetX;
                this.y = this.targetY;
                this.arrived();
            }
            else {
                var rad = Math.atan((fromX - toX) / (fromY - toY));
                var winkel = 0;
                if (fromY > toY) {
                    winkel = 360 - rad * (180) / Math.PI;
                }
                else {
                    winkel = 180 - rad * (180) / Math.PI;
                }
                var s = ("" + winkel).replace(",", ".");
                this.dom.style.transform = "rotate(" + s + "deg)";
                // console.log(pixelToTarget+" pixel in "+toTime+" seconds. Position "+nowX+" "+nowY+" lastupdate "+nowTime+" "+winkel+"Â°");
                this.x = nowX;
                this.y = nowY;
            }
        }
        update() {
            if (this.targetX !== undefined) {
                this.calcNewPosition();
            }
            this.lastUpdate = this.world.game.date.getTime();
            this.dom.style.top = this.y + "px";
            this.dom.style.left = (this.x - 15) + "px";
            if (this.activeRoute !== -1 && this.route.length > 1) {
                if (this.action === "unload" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    console.log("load now");
                    this.action = "load";
                    this.status = "load";
                    this.lastAction = this.lastUpdate;
                }
                if (this.action === "load" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    this.activeRoute++;
                    if (this.activeRoute === this.route.length)
                        this.activeRoute = 0;
                    var city = this.world.cities[this.route[this.activeRoute].cityid];
                    this.flyTo(city);
                    this.lastAction = this.lastUpdate;
                }
            }
        }
        onclick(th) {
            var _a;
            th.stopPropagation();
            console.log(this.name);
            (_a = this.world.selection) === null || _a === void 0 ? void 0 : _a.unselect();
            this.world.selection = this;
            this.select();
            var h = airplanedialog_1.AirplaneDialog.getInstance();
            h.airplane = this;
            h.show();
        }
    }
    exports.Airplane = Airplane;
});
//<span style='font-size:100px;'>&#9951;</span>
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlycGxhbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL2FpcnBsYW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFNQSxTQUFTLFlBQVksQ0FBQyxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELE1BQWEsUUFBUTtRQWlCakIsWUFBWSxLQUFZO1lBSHhCLFdBQU0sR0FBVyxFQUFFLENBQUM7WUFFcEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7WUFFWixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNoQjs7OztpQkFJSztRQUNULENBQUM7UUFDRCxNQUFNO1lBQ0YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQVEsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLHdCQUF3QixDQUFDLHdFQUF3RSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEsaUNBQWlDO1lBQ3ZMLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFDckMsSUFBSSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHFC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Q0FBQyxHQUFHLElBQUksR0FBQyxFQUFFLEdBQUMsRUFBRSxDQUFDLEVBQUU7b0JBQzlFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztvQkFDbkIsSUFBRyxJQUFJLENBQUMsV0FBVyxLQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTt3QkFDbkMsSUFBSSxDQUFDLFdBQVcsR0FBQyxDQUFDLENBQUM7b0JBQ3ZCLElBQUksSUFBSSxHQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7aUJBQ3JDO2FBQ0o7UUFDTCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEVBQWM7O1lBQ2xCLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2QixNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUywwQ0FBRSxRQUFRLEVBQUUsQ0FBQztZQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2QsSUFBSSxDQUFDLEdBQUcsK0JBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNyQyxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUNsQixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFHYixDQUFDO0tBQ0o7SUE1SkQsNEJBNEpDOztBQUVELCtDQUErQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFdvcmxkIH0gZnJvbSBcImdhbWUvd29ybGRcIjtcbmltcG9ydCB7IGFsbFByb2R1Y3RzIH0gZnJvbSBcImdhbWUvcHJvZHVjdFwiO1xuaW1wb3J0IHsgQWlycGxhbmVEaWFsb2cgfSBmcm9tIFwiZ2FtZS9haXJwbGFuZWRpYWxvZ1wiO1xuaW1wb3J0IHsgUm91dGUgfSBmcm9tIFwiZ2FtZS9yb3V0ZVwiO1xuaW1wb3J0IHsgQ2l0eSB9IGZyb20gXCJnYW1lL2NpdHlcIjtcblxuZnVuY3Rpb24gZ2V0UmFuZG9tSW50KG1heCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpO1xufVxuXG5leHBvcnQgY2xhc3MgQWlycGxhbmUge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBhY3Rpb246IHN0cmluZztcbiAgICBsYXN0QWN0aW9uOiBudW1iZXI7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbiAgICAvL3BpeGVsIHBybyBzZWNvbmRcbiAgICBzcGVlZDogbnVtYmVyO1xuICAgIGxhc3RVcGRhdGU6IG51bWJlcjtcbiAgICB0YXJnZXRYOiBudW1iZXI7XG4gICAgdGFyZ2V0WTogbnVtYmVyO1xuICAgIGRvbTogSFRNTFNwYW5FbGVtZW50O1xuICAgIHdvcmxkOiBXb3JsZDtcbiAgICBwcm9kdWN0cztcbiAgICBzdGF0dXM6IHN0cmluZyA9IFwiXCI7XG4gICAgcm91dGU6IFJvdXRlW107XG4gICAgYWN0aXZlUm91dGUgPSAwO1xuICAgIGNvbnN0cnVjdG9yKHdvcmxkOiBXb3JsZCkge1xuICAgICAgICB0aGlzLndvcmxkID0gd29ybGQ7XG4gICAgICAgIHRoaXMucm91dGUgPSBbXTtcbiAgICAgICAgLyogIGZvcih2YXIgeD0wO3g8NDt4Kyspe1xuICAgICAgICAgICAgICB2YXIgcnQ9bmV3IFJvdXRlKCk7XG4gICAgICAgICAgICAgIHJ0LmNpdHlpZD14O1xuICAgICAgICAgICAgICB0aGlzLnJvdXRlLnB1c2gocnQpO1xuICAgICAgICAgIH0qL1xuICAgIH1cbiAgICBjcmVhdGUoKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHRoaXMuZG9tID0gPGFueT5kb2N1bWVudC5jcmVhdGVSYW5nZSgpLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudChcIjxzcGFuIHN0eWxlPSd0cmFuc2Zvcm06cm90YXRlKDB0dXJuKScgY2xhc3M9J21kaSBtZGktYWlycGxhbmUnPjwvc3Bhbj5cIikuY2hpbGRyZW5bMF07Ly9kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgICAgIHRoaXMueCA9IGdldFJhbmRvbUludCh0aGlzLndvcmxkLmdhbWUubWFwV2lkdGgpO1xuICAgICAgICB0aGlzLnkgPSBnZXRSYW5kb21JbnQodGhpcy53b3JsZC5nYW1lLm1hcEhlaWdodCk7XG4gICAgICAgIHRoaXMuYWN0aW9uID0gXCJ3YWl0XCI7XG4gICAgICAgIHRoaXMucHJvZHVjdHMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCBhbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgdGhpcy5wcm9kdWN0c1t4XSA9IDA7XG5cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRvbS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICBfdGhpcy5vbmNsaWNrKGV2KTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG5cbiAgICB9XG5cbiAgICBmbHlUbyhjaXR5OkNpdHkpIHtcbiAgICAgICAgdmFyIHg9Y2l0eS54O1xuICAgICAgICB2YXIgeT1jaXR5Lnk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZmx5IHRvIFwiICsgY2l0eS5uYW1lKVxuICAgICAgICB0aGlzLmFjdGlvbiA9IFwiZmx5XCI7XG4gICAgICAgIHRoaXMuc3RhdHVzPVwiZmx5IHRvIFwiKyBjaXR5Lm5hbWU7XG4gICAgICAgIHRoaXMudGFyZ2V0WCA9IHg7XG4gICAgICAgIHRoaXMudGFyZ2V0WSA9IHk7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy53b3JsZC5jaXRpZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBwb3MgPSB0aGlzLndvcmxkLmNpdGllc1tpXS5haXJwbGFuZXNJbkNpdHkuaW5kZXhPZih0aGlzKTtcbiAgICAgICAgICAgIGlmIChwb3MgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53b3JsZC5jaXRpZXNbaV0uYWlycGxhbmVzSW5DaXR5LnNwbGljZShwb3MsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHNlbGVjdCgpIHtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUuY29sb3IgPSBcInJlZFwiO1xuICAgIH1cbiAgICB1bnNlbGVjdCgpIHtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUuY29sb3IgPSBcImJsYWNrXCI7XG4gICAgfVxuICAgIGFycml2ZWQoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGFyZ2V0IGFycml2ZWRcIik7XG4gICAgICAgIHRoaXMudGFyZ2V0WCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy50YXJnZXRZID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFjdGlvbiA9IFwid2FpdFwiO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IFwiXCI7XG4gICAgICAgIHRoaXMud29ybGQuZmluZENpdHlBdCh0aGlzLngsIHRoaXMueSk/LmFpcnBsYW5lc0luQ2l0eS5wdXNoKHRoaXMpO1xuICAgICAgICB0aGlzLmRvbS5zdHlsZS50cmFuc2Zvcm0gPSBcInJvdGF0ZSgwZGVnKVwiO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVSb3V0ZSAhPT0gLTEpIHtcbiAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInVubG9hZCBub3dcIik7XG4gICAgICAgICAgICB0aGlzLmFjdGlvbiA9IFwidW5sb2FkXCI7XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwidW5sb2FkXCI7XG4gICAgICAgICAgICB0aGlzLmxhc3RBY3Rpb24gPSB0aGlzLmxhc3RVcGRhdGU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2FsY05ld1Bvc2l0aW9uKCkge1xuICAgICAgICB2YXIgcGl4ZWxUb1RhcmdldCA9IE1hdGgucm91bmQoTWF0aC5zcXJ0KE1hdGgucG93KHRoaXMudGFyZ2V0WCAtIHRoaXMueCwgMikgKyBNYXRoLnBvdyh0aGlzLnRhcmdldFkgLSB0aGlzLnksIDIpKSk7Ly9QeXRoYXJvcmFzXG4gICAgICAgIHZhciBmcm9tWCA9IHRoaXMueDtcbiAgICAgICAgdmFyIGZyb21ZID0gdGhpcy55O1xuICAgICAgICB2YXIgZnJvbVRpbWUgPSAwO1xuICAgICAgICB2YXIgdG9YID0gdGhpcy50YXJnZXRYO1xuICAgICAgICB2YXIgdG9ZID0gdGhpcy50YXJnZXRZO1xuICAgICAgICB2YXIgdG9UaW1lID0gcGl4ZWxUb1RhcmdldCAvIHRoaXMuc3BlZWQ7ICAgIC8vdD1zL3Y7IGluIFRhZ2VcbiAgICAgICAgdmFyIHNwZWVkVmVjdG9yWCA9IHRvWCAtIGZyb21YO1xuICAgICAgICB2YXIgc3BlZWRWZWN0b3JZID0gdG9ZIC0gZnJvbVk7XG4gICAgICAgIHZhciBzcGVlZFZlY3RvclRpbWUgPSAodG9UaW1lIC0gZnJvbVRpbWUpO1xuICAgICAgICB2YXIgbm93VGltZSA9ICh0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCkgLSB0aGlzLmxhc3RVcGRhdGUpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuICAgICAgICB2YXIgbm93WCA9IE1hdGgucm91bmQoKG5vd1RpbWUgLyBzcGVlZFZlY3RvclRpbWUpICogc3BlZWRWZWN0b3JYICsgZnJvbVgpO1xuICAgICAgICB2YXIgbm93WSA9IE1hdGgucm91bmQoKG5vd1RpbWUgLyBzcGVlZFZlY3RvclRpbWUpICogc3BlZWRWZWN0b3JZICsgZnJvbVkpO1xuICAgICAgICBpZiAobm93VGltZSA+PSB0b1RpbWUpIHtcbiAgICAgICAgICAgIHRoaXMueCA9IHRoaXMudGFyZ2V0WDtcbiAgICAgICAgICAgIHRoaXMueSA9IHRoaXMudGFyZ2V0WTtcbiAgICAgICAgICAgIHRoaXMuYXJyaXZlZCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIHJhZCA9IE1hdGguYXRhbigoZnJvbVggLSB0b1gpIC8gKGZyb21ZIC0gdG9ZKSk7XG4gICAgICAgICAgICB2YXIgd2lua2VsID0gMDtcbiAgICAgICAgICAgIGlmIChmcm9tWSA+IHRvWSkge1xuICAgICAgICAgICAgICAgIHdpbmtlbCA9IDM2MCAtIHJhZCAqICgxODApIC8gTWF0aC5QSTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2lua2VsID0gMTgwIC0gcmFkICogKDE4MCkgLyBNYXRoLlBJO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHMgPSAoXCJcIiArIHdpbmtlbCkucmVwbGFjZShcIixcIiwgXCIuXCIpO1xuICAgICAgICAgICAgdGhpcy5kb20uc3R5bGUudHJhbnNmb3JtID0gXCJyb3RhdGUoXCIgKyBzICsgXCJkZWcpXCI7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhwaXhlbFRvVGFyZ2V0K1wiIHBpeGVsIGluIFwiK3RvVGltZStcIiBzZWNvbmRzLiBQb3NpdGlvbiBcIitub3dYK1wiIFwiK25vd1krXCIgbGFzdHVwZGF0ZSBcIitub3dUaW1lK1wiIFwiK3dpbmtlbCtcIsKwXCIpO1xuICAgICAgICAgICAgdGhpcy54ID0gbm93WDtcbiAgICAgICAgICAgIHRoaXMueSA9IG5vd1k7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdXBkYXRlKCkge1xuXG4gICAgICAgIGlmICh0aGlzLnRhcmdldFggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5jYWxjTmV3UG9zaXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLnRvcCA9IHRoaXMueSArIFwicHhcIjtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUubGVmdCA9ICh0aGlzLnggLSAxNSkgKyBcInB4XCI7XG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZVJvdXRlICE9PSAtMSYmdGhpcy5yb3V0ZS5sZW5ndGg+MSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uPT09XCJ1bmxvYWRcIiYmKHRoaXMubGFzdFVwZGF0ZSAtIHRoaXMubGFzdEFjdGlvbikgPiAoMyAqIDEwMDAqNjAqNjApKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJsb2FkIG5vd1wiKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGlvbiA9IFwibG9hZFwiO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gXCJsb2FkXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uPT09XCJsb2FkXCImJih0aGlzLmxhc3RVcGRhdGUgLSB0aGlzLmxhc3RBY3Rpb24pID4gKDMgKiAxMDAwKjYwKjYwKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUm91dGUrKztcbiAgICAgICAgICAgICAgICBpZih0aGlzLmFjdGl2ZVJvdXRlPT09dGhpcy5yb3V0ZS5sZW5ndGgpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlUm91dGU9MDtcbiAgICAgICAgICAgICAgICB2YXIgY2l0eT10aGlzLndvcmxkLmNpdGllc1t0aGlzLnJvdXRlW3RoaXMuYWN0aXZlUm91dGVdLmNpdHlpZF07XG4gICAgICAgICAgICAgICAgdGhpcy5mbHlUbyhjaXR5KTtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RBY3Rpb24gPSB0aGlzLmxhc3RVcGRhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgb25jbGljayh0aDogTW91c2VFdmVudCkge1xuICAgICAgICB0aC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5uYW1lKTtcbiAgICAgICAgdGhpcy53b3JsZC5zZWxlY3Rpb24/LnVuc2VsZWN0KCk7XG4gICAgICAgIHRoaXMud29ybGQuc2VsZWN0aW9uID0gdGhpcztcbiAgICAgICAgdGhpcy5zZWxlY3QoKTtcbiAgICAgICAgdmFyIGggPSBBaXJwbGFuZURpYWxvZy5nZXRJbnN0YW5jZSgpO1xuICAgICAgICBoLmFpcnBsYW5lID0gdGhpcztcbiAgICAgICAgaC5zaG93KCk7XG5cblxuICAgIH1cbn1cblxuLy88c3BhbiBzdHlsZT0nZm9udC1zaXplOjEwMHB4Oyc+JiM5OTUxOzwvc3Bhbj4iXX0=