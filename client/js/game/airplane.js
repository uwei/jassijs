define(["require", "exports", "game/product", "game/airplanedialog"], function (require, exports, product_1, airplanedialog_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Airplane = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    class Airplane {
        constructor() {
            this.status = "";
        }
        create() {
            var _this = this;
            this.dom = document.createRange().createContextualFragment("<span style='transform:rotate(0turn)' class='mdi mdi-airplane'></span>").children[0]; //document.createElement("span");
            this.dom.style.position = "absolute";
            this.x = getRandomInt(500);
            this.y = getRandomInt(500);
            this.action = "wait";
            this.products = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.products[x] = 0;
            }
            this.dom.addEventListener("click", (ev) => {
                _this.onclick(ev);
                return undefined;
            });
            this.update();
        }
        flyTo(x, y) {
            console.log("fly to " + x + ":" + y);
            this.action = "fly";
            this.targetX = x;
            this.targetY = y;
            this.update();
            for (var i = 0; i < this.world.cities.length; i++) {
                var pos = this.world.cities[i].airplanesInCity.indexOf(this);
                if (pos !== -1) {
                    this.world.cities[i].airplanesInCity.splice(pos, 1);
                }
            }
        }
        select() {
            this.dom.style.color = "red";
        }
        unselect() {
            this.dom.style.color = "black";
        }
        calcNewPosition() {
            var _a;
            var pixelToTarget = Math.round(Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2))); //Pytharoras
            var fromX = this.x;
            var fromY = this.y;
            var fromTime = 0;
            var toX = this.targetX;
            var toY = this.targetY;
            var toTime = pixelToTarget / this.speed; //t=s/v;
            var speedVectorX = toX - fromX;
            var speedVectorY = toY - fromY;
            var speedVectorTime = (toTime - fromTime) / this.world.game.speed;
            var nowTime = (Date.now() - this.lastUpdate) / 1000;
            var nowX = Math.round((nowTime / speedVectorTime) * speedVectorX + fromX);
            var nowY = Math.round((nowTime / speedVectorTime) * speedVectorY + fromY);
            if (nowTime >= toTime) {
                this.x = this.targetX;
                this.y = this.targetY;
                console.log("target arrived");
                this.targetX = undefined;
                this.targetY = undefined;
                this.action = "wait";
                this.status = "";
                (_a = this.world.findCityAt(this.x, this.y)) === null || _a === void 0 ? void 0 : _a.airplanesInCity.push(this);
                this.dom.style.transform = "rotate(0deg)";
            }
            else {
                var rad = Math.atan((fromX - toX) / (fromY - toY));
                var winkel = 0;
                if (fromY > toY) {
                    winkel = 360 - rad * (180) / Math.PI;
                }
                else {
                    winkel = 180 - rad * (180) / Math.PI;
                }
                var s = ("" + winkel).replace(",", ".");
                this.dom.style.transform = "rotate(" + s + "deg)";
                // console.log(pixelToTarget+" pixel in "+toTime+" seconds. Position "+nowX+" "+nowY+" lastupdate "+nowTime+" "+winkel+"Â°");
                this.x = nowX;
                this.y = nowY;
            }
        }
        update() {
            if (this.lastUpdate === undefined) {
                this.lastUpdate = Date.now();
            }
            if (this.targetX !== undefined) {
                this.calcNewPosition();
            }
            this.lastUpdate = Date.now();
            this.dom.style.top = this.y + "px";
            this.dom.style.left = this.x + "px";
        }
        onclick(th) {
            var _a;
            th.stopPropagation();
            console.log(this.name);
            (_a = this.world.selection) === null || _a === void 0 ? void 0 : _a.unselect();
            this.world.selection = this;
            this.select();
            var h = airplanedialog_1.AirplaneDialog.getInstance();
            h.airplane = this;
            h.show();
        }
    }
    exports.Airplane = Airplane;
});
//<span style='font-size:100px;'>&#9951;</span>
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlycGxhbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL2FpcnBsYW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFJQSxTQUFTLFlBQVksQ0FBQyxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELE1BQWEsUUFBUTtRQUFyQjtZQWFJLFdBQU0sR0FBUSxFQUFFLENBQUM7UUFzR2pCLENBQUM7UUFyR0QsTUFBTTtZQUNGLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztZQUNqQixJQUFJLENBQUMsR0FBRyxHQUFRLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyx3QkFBd0IsQ0FBQyx3RUFBd0UsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLGlDQUFpQztZQUN2TCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxDQUFDLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxDQUFDLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUMsTUFBTSxDQUFDO1lBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUMsRUFBRSxDQUFDO1lBQ2pCLEtBQUksSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFDLENBQUMsR0FBQyxxQkFBVyxDQUFDLE1BQU0sRUFBQyxDQUFDLEVBQUUsRUFBQztnQkFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUM7YUFFdEI7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQWMsRUFBRSxFQUFFO2dCQUNsRCxLQUFLLENBQUMsT0FBTyxD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Q0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWIsQ0FBQztLQUNBO0lBbkhMLDRCQW1ISzs7QUFHTCwrQ0FBK0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBXb3JsZCB9IGZyb20gXCJnYW1lL3dvcmxkXCI7XG5pbXBvcnQgeyBhbGxQcm9kdWN0cyB9IGZyb20gXCJnYW1lL3Byb2R1Y3RcIjtcbmltcG9ydCB7IEFpcnBsYW5lRGlhbG9nIH0gZnJvbSBcImdhbWUvYWlycGxhbmVkaWFsb2dcIjtcblxuZnVuY3Rpb24gZ2V0UmFuZG9tSW50KG1heCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpO1xufVxuXG5leHBvcnQgY2xhc3MgQWlycGxhbmUge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBhY3Rpb246c3RyaW5nO1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gICAgLy9waXhlbCBwcm8gc2Vjb25kXG4gICAgc3BlZWQ6IG51bWJlcjtcbiAgICBsYXN0VXBkYXRlOiBudW1iZXI7XG4gICAgdGFyZ2V0WDogbnVtYmVyO1xuICAgIHRhcmdldFk6IG51bWJlcjtcbiAgICBkb206IEhUTUxTcGFuRWxlbWVudDtcbiAgICB3b3JsZDogV29ybGQ7XG4gICAgcHJvZHVjdHM7XG4gICAgc3RhdHVzOnN0cmluZz1cIlwiO1xuICAgIGNyZWF0ZSgpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgdGhpcy5kb20gPSA8YW55PmRvY3VtZW50LmNyZWF0ZVJhbmdlKCkuY3JlYXRlQ29udGV4dHVhbEZyYWdtZW50KFwiPHNwYW4gc3R5bGU9J3RyYW5zZm9ybTpyb3RhdGUoMHR1cm4pJyBjbGFzcz0nbWRpIG1kaS1haXJwbGFuZSc+PC9zcGFuPlwiKS5jaGlsZHJlblswXTsvL2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xuICAgICAgICB0aGlzLmRvbS5zdHlsZS5wb3NpdGlvbiA9IFwiYWJzb2x1dGVcIjtcbiAgICAgICAgdGhpcy54ID0gZ2V0UmFuZG9tSW50KDUwMCk7XG4gICAgICAgIHRoaXMueSA9IGdldFJhbmRvbUludCg1MDApO1xuICAgICAgICB0aGlzLmFjdGlvbj1cIndhaXRcIjtcbiAgICAgICAgdGhpcy5wcm9kdWN0cz1bXTtcbiAgICAgICAgZm9yKHZhciB4PTA7eDxhbGxQcm9kdWN0cy5sZW5ndGg7eCsrKXtcbiAgICAgICAgICAgIHRoaXMucHJvZHVjdHNbeF09MDtcblxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZG9tLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIF90aGlzLm9uY2xpY2soZXYpO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG5cbiAgICB9XG4gICAgXG4gICAgZmx5VG8oeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJmbHkgdG8gXCIreCtcIjpcIit5KVxuICAgICAgICB0aGlzLmFjdGlvbj1cImZseVwiO1xuICAgICAgICB0aGlzLnRhcmdldFggPSB4O1xuICAgICAgICB0aGlzLnRhcmdldFkgPSB5O1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgICAgICBmb3IodmFyIGk9MDtpPHRoaXMud29ybGQuY2l0aWVzLmxlbmd0aDtpKyspe1xuICAgICAgICAgICAgdmFyIHBvcz10aGlzLndvcmxkLmNpdGllc1tpXS5haXJwbGFuZXNJbkNpdHkuaW5kZXhPZih0aGlzKTtcbiAgICAgICAgICAgIGlmKHBvcyE9PS0xKXtcbiAgICAgICAgICAgICAgICB0aGlzLndvcmxkLmNpdGllc1tpXS5haXJwbGFuZXNJbkNpdHkuc3BsaWNlKHBvcywxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWxlY3QoKSB7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmNvbG9yID0gXCJyZWRcIjtcbiAgICB9XG4gICAgdW5zZWxlY3QoKSB7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmNvbG9yID0gXCJibGFja1wiO1xuICAgIH1cbiAgICBjYWxjTmV3UG9zaXRpb24oKXtcbiAgICAgICAgdmFyIHBpeGVsVG9UYXJnZXQ9TWF0aC5yb3VuZCggTWF0aC5zcXJ0KE1hdGgucG93KHRoaXMudGFyZ2V0WC10aGlzLngsMikrTWF0aC5wb3codGhpcy50YXJnZXRZLXRoaXMueSwyKSkpOy8vUHl0aGFyb3Jhc1xuICAgICAgICB2YXIgZnJvbVg9dGhpcy54O1xuICAgICAgICB2YXIgZnJvbVk9dGhpcy55O1xuICAgICAgICB2YXIgZnJvbVRpbWU9MDtcbiAgICAgICAgdmFyIHRvWD10aGlzLnRhcmdldFg7XG4gICAgICAgIHZhciB0b1k9dGhpcy50YXJnZXRZO1xuICAgICAgICB2YXIgdG9UaW1lPXBpeGVsVG9UYXJnZXQvdGhpcy5zcGVlZDsgICAgLy90PXMvdjtcbiAgICAgICAgdmFyIHNwZWVkVmVjdG9yWD10b1gtZnJvbVg7XG4gICAgICAgIHZhciBzcGVlZFZlY3Rvclk9dG9ZLWZyb21ZO1xuICAgICAgICB2YXIgc3BlZWRWZWN0b3JUaW1lPSh0b1RpbWUtZnJvbVRpbWUpL3RoaXMud29ybGQuZ2FtZS5zcGVlZDtcbiAgICAgICAgdmFyIG5vd1RpbWU9KERhdGUubm93KCktdGhpcy5sYXN0VXBkYXRlKS8xMDAwO1xuICAgICAgICB2YXIgbm93WD1NYXRoLnJvdW5kKChub3dUaW1lL3NwZWVkVmVjdG9yVGltZSkqc3BlZWRWZWN0b3JYK2Zyb21YKTtcbiAgICAgICAgdmFyIG5vd1k9TWF0aC5yb3VuZCgobm93VGltZS9zcGVlZFZlY3RvclRpbWUpKnNwZWVkVmVjdG9yWStmcm9tWSk7XG4gICAgICAgIGlmKG5vd1RpbWU+PXRvVGltZSl7XG4gICAgICAgICAgICB0aGlzLng9dGhpcy50YXJnZXRYO1xuICAgICAgICAgICAgdGhpcy55PXRoaXMudGFyZ2V0WTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGFyZ2V0IGFycml2ZWRcIik7XG4gICAgICAgICAgICB0aGlzLnRhcmdldFg9dW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy50YXJnZXRZPXVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRoaXMuYWN0aW9uPVwid2FpdFwiO1xuICAgICAgICAgICAgdGhpcy5zdGF0dXM9XCJcIjtcbiAgICAgICAgICAgIHRoaXMud29ybGQuZmluZENpdHlBdCh0aGlzLngsdGhpcy55KT8uYWlycGxhbmVzSW5DaXR5LnB1c2godGhpcyk7XG4gICAgICAgICAgICB0aGlzLmRvbS5zdHlsZS50cmFuc2Zvcm09XCJyb3RhdGUoMGRlZylcIjtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB2YXIgcmFkPU1hdGguYXRhbigoZnJvbVgtdG9YKS8oZnJvbVktdG9ZKSk7XG4gICAgICAgICAgICB2YXIgd2lua2VsPTA7XG4gICAgICAgICAgICBpZihmcm9tWT50b1kpe1xuICAgICAgICAgICAgICAgIHdpbmtlbD0zNjAtcmFkKigxODApL01hdGguUEk7XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICB3aW5rZWw9MTgwLXJhZCooMTgwKS9NYXRoLlBJO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHM9KFwiXCIrd2lua2VsKS5yZXBsYWNlKFwiLFwiLFwiLlwiKTtcbiAgICAgICAgICAgIHRoaXMuZG9tLnN0eWxlLnRyYW5zZm9ybT1cInJvdGF0ZShcIitzK1wiZGVnKVwiO1xuICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhwaXhlbFRvVGFyZ2V0K1wiIHBpeGVsIGluIFwiK3RvVGltZStcIiBzZWNvbmRzLiBQb3NpdGlvbiBcIitub3dYK1wiIFwiK25vd1krXCIgbGFzdHVwZGF0ZSBcIitub3dUaW1lK1wiIFwiK3dpbmtlbCtcIsKwXCIpO1xuICAgICAgICAgICAgdGhpcy54PW5vd1g7XG4gICAgICAgICAgICB0aGlzLnk9bm93WTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB1cGRhdGUoKSB7XG4gICAgICAgIGlmKHRoaXMubGFzdFVwZGF0ZT09PXVuZGVmaW5lZCl7XG4gICAgICAgICAgICB0aGlzLmxhc3RVcGRhdGU9RGF0ZS5ub3coKTtcbiAgICAgICAgfVxuICAgICAgICBpZih0aGlzLnRhcmdldFghPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgdGhpcy5jYWxjTmV3UG9zaXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxhc3RVcGRhdGU9RGF0ZS5ub3coKTtcbiAgICAgICB0aGlzLmRvbS5zdHlsZS50b3AgPSB0aGlzLnkgKyBcInB4XCI7XG4gICAgICAgdGhpcy5kb20uc3R5bGUubGVmdCA9IHRoaXMueCArIFwicHhcIjtcblxuICAgIH1cbiAgICBvbmNsaWNrKHRoOiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIHRoLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLm5hbWUpO1xuICAgICAgICB0aGlzLndvcmxkLnNlbGVjdGlvbj8udW5zZWxlY3QoKTtcbiAgICAgICAgdGhpcy53b3JsZC5zZWxlY3Rpb24gPSB0aGlzO1xuICAgICAgICB0aGlzLnNlbGVjdCgpO1xuICAgICAgICB2YXIgaCA9IEFpcnBsYW5lRGlhbG9nLmdldEluc3RhbmNlKCk7XG4gICAgICAgIGguYWlycGxhbmUgPSB0aGlzO1xuICAgICAgICBoLnNob3coKTtcblxuICAgIH1cbiAgICB9XG59XG5cbi8vPHNwYW4gc3R5bGU9J2ZvbnQtc2l6ZToxMDBweDsnPiYjOTk1MTs8L3NwYW4+Il19