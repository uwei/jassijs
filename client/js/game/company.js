define(["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.test = exports.Company = exports.debugNeed = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    var distributionTable = undefined;
    var debugNeed = [];
    exports.debugNeed = debugNeed;
    for (var x = 0; x < 19; x++) {
        debugNeed.push(0);
    }
    function getRandomCompanyType(notThisIds = undefined) {
        if (notThisIds === undefined)
            notThisIds = [];
        if (!distributionTable) {
            distributionTable = [];
            var distCount = 0;
            for (var x = 0; x < parameter.allProducts.length; x++) {
                for (var y = 0; y < parameter.allProducts[x].distribution; y++) {
                    distributionTable.push(parameter.allProducts[x].id);
                }
            }
        }
        var rand = undefined;
        while (rand === undefined || notThisIds.indexOf(rand) > -1) {
            rand = getRandomInt(distributionTable.length);
            rand = distributionTable[rand];
        }
        return rand;
    }
    class Company {
        // static workerInCompany=20;
        constructor(notThisIds = undefined) {
            this.buildings = 0;
            this.workers = 0;
            this.hasLicense = false;
            this.type = "Company";
            this.dailyProducedToday = 0;
            this.productid = getRandomCompanyType(notThisIds);
            this.buildings = 0; // getRandomInt(3)+1;
            this.workers = parameter.workerInCompany * this.buildings;
            this.hasLicense = (parameter.allProducts[this.productid].distribution <= 8) ? false : true;
        }
        getMaxWorkers() {
            return this.buildings * parameter.workerInCompany;
        }
        getDailyProduce() {
            var produce = this.workers * parameter.allProducts[this.productid].dailyProduce / parameter.workerInCompany;
            return Math.round(produce);
        }
        getDailyInput1() {
            var needs = 0;
            var product = parameter.allProducts[this.productid];
            if (product.input1 !== undefined) {
                var p = parameter.allProducts[product.input1];
                needs = this.workers * product.input1Amount / parameter.workerInCompany;
            }
            return needs;
        }
        getDayilyCosts() {
            var fact = 8;
            if (parameter.allProducts[this.productid].distribution === 8) {
                fact = 9;
            }
            if (parameter.allProducts[this.productid].distribution === 4) {
                fact = 10;
            }
            return Math.round(this.workers * fact / parameter.allProducts[this.productid].dailyProduce);
        }
        getBuildingMaterial() {
            var fact = 5 - (parameter.allProducts[this.productid].distribution) / 4;
            return [
                fact * 15,
                fact * 15
            ];
        }
        getBuildingCosts() {
            var fact = 5 - (parameter.allProducts[this.productid].distribution) / 4;
            return Math.round(parameter.rateBuyBuilding * fact * 10000 + Math.round(parameter.rateBuyBuildingGrowFactor * this.buildings));
        }
        getDailyInput2() {
            var needs = 0;
            var product = parameter.allProducts[this.productid];
            if (product.input2 !== undefined) {
                needs = this.workers * product.input2Amount / parameter.workerInCompany;
            }
            return needs;
        }
        update() {
            if (this.lastUpdate === undefined) {
                this.lastUpdate = this.city.world.game.date.getTime();
            }
            this.updateProduction();
            this.lastUpdate = this.city.world.game.date.getTime();
        }
        updateProduction() {
            if (this.workers === 0)
                return;
            var dayProcent = this.city.world.game.date.getHours() / 24;
            //  if (this.city.world.game.date.getDate() !== new Date(this.lastUpdate).getDate()) {
            if (this.city.world.game.date.getHours() === 23) {
                dayProcent = 1;
            }
            var prod = this.productid;
            var totalDailyProduce = Math.round(this.workers * parameter.allProducts[prod].dailyProduce / parameter.workerInCompany);
            var totalDailyNeed1 = undefined;
            var totalDailyNeed2 = undefined;
            if (parameter.allProducts[prod].input1 !== undefined)
                totalDailyNeed1 = Math.round(this.workers * parameter.allProducts[prod].input1Amount / parameter.workerInCompany);
            if (parameter.allProducts[prod].input2 !== undefined)
                totalDailyNeed2 = Math.round(this.workers * parameter.allProducts[prod].input2Amount / parameter.workerInCompany);
            if (this.dailyProducedToday === 0 && totalDailyNeed1 !== undefined) {
                if (totalDailyNeed1 >= this.city.shop[parameter.allProducts[prod].input1]) {
                    // console.log(totalDailyNeed1 + "x" + parameter.allProducts[prod].input1 + " needed");
                    return;
                }
                else {
                }
            }
            if (this.dailyProducedToday === 0 && totalDailyNeed2 !== undefined) {
                if (totalDailyNeed2 >= this.city.shop[parameter.allProducts[prod].input2]) {
                    // console.log(totalDailyNeed2 + "x" + parameter.allProducts[prod].input2 + " needed");
                    return;
                }
            }
            var untilNow = Math.round(totalDailyProduce * dayProcent);
            if (untilNow > this.dailyProducedToday) {
                var diff = untilNow - this.dailyProducedToday;
                if (diff > 0) {
                    if (this.dailyProducedToday === 0) {
                        if (totalDailyNeed1 !== undefined) {
                            this.city.shop[parameter.allProducts[prod].input1] -= totalDailyNeed1;
                            debugNeed[parameter.allProducts[prod].input1] += totalDailyNeed1;
                        }
                        if (totalDailyNeed2 !== undefined) {
                            this.city.shop[parameter.allProducts[prod].input2] -= totalDailyNeed2;
                            debugNeed[parameter.allProducts[prod].input2] += totalDailyNeed2;
                        }
                    }
                    this.city.shop[prod] += diff;
                    // console.log(diff + "x" + prod + " produced");
                    this.dailyProducedToday = this.dailyProducedToday + diff;
                }
            }
            if (dayProcent === 1) {
                //console.log("prod "+this.productid+ " "+this.dailyProducedToday);
                this.dailyProducedToday = 0;
            }
        }
    }
    exports.Company = Company;
    function test() {
        var ids = [];
        var t = [];
        for (var x = 0; x < parameter.allProducts.length; x++) {
            var h = new Company(ids);
            ids.push(h.productid);
            t.push(h.productid);
        }
        t.sort();
        for (var x = 0; x < t.length; x++) {
            console.log(t[x]);
        }
    }
    exports.test = test;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGFueS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2dhbWUvY29tcGFueS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0lBR0EsU0FBUyxZQUFZLENBQUMsR0FBRztRQUNyQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFDRCxJQUFJLGlCQUFpQixHQUFhLFNBQVMsQ0FBQztJQUM1QyxJQUFJLFNBQVMsR0FBQyxFQUFFLENBQUM7SUFJVCw4QkFBUztJQUhqQixLQUFJLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBQyxDQUFDLEdBQUMsRUFBRSxFQUFDLENBQUMsRUFBRSxFQUFDO1FBQ2pCLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDckI7SUFFRCxTQUFTLG9CQUFvQixDQUFDLGFBQXVCLFNBQVM7UUFDMUQsSUFBSSxVQUFVLEtBQUssU0FBUztZQUN4QixVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixpQkFBaUIsR0FBRyxFQUFFLENBQUM7WUFDdkIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUM1RCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDdkQ7YUFDSjtTQUNKO1FBQ0QsSUFBSSxJQUFJLEdBQUcs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QyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDckI7SUFDTCxDQUFDO0lBWkQsb0JBWUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJY29ucyB9IGZyb20gXCJnYW1lL2ljb25zXCI7XG5pbXBvcnQgeyBDaXR5IH0gZnJvbSBcImdhbWUvY2l0eVwiO1xuXG5mdW5jdGlvbiBnZXRSYW5kb21JbnQobWF4KSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG1heCk7XG59XG52YXIgZGlzdHJpYnV0aW9uVGFibGU6IG51bWJlcltdID0gdW5kZWZpbmVkO1xudmFyIGRlYnVnTmVlZD1bXTtcbmZvcih2YXIgeD0wO3g8MTk7eCsrKXtcbiAgICBkZWJ1Z05lZWQucHVzaCgwKTtcbn1cbmV4cG9ydCB7ZGVidWdOZWVkfTtcbmZ1bmN0aW9uIGdldFJhbmRvbUNvbXBhbnlUeXBlKG5vdFRoaXNJZHM6IG51bWJlcltdID0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKG5vdFRoaXNJZHMgPT09IHVuZGVmaW5lZClcbiAgICAgICAgbm90VGhpc0lkcyA9IFtdO1xuICAgIGlmICghZGlzdHJpYnV0aW9uVGFibGUpIHtcbiAgICAgICAgZGlzdHJpYnV0aW9uVGFibGUgPSBbXTtcbiAgICAgICAgdmFyIGRpc3RDb3VudCA9IDA7XG4gICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgcGFyYW1ldGVyLmFsbFByb2R1Y3RzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IHBhcmFtZXRlci5hbGxQcm9kdWN0c1t4XS5kaXN0cmlidXRpb247IHkrKykge1xuICAgICAgICAgICAgICAgIGRpc3RyaWJ1dGlvblRhYmxlLnB1c2gocGFyYW1ldGVyLmFsbFByb2R1Y3RzW3hdLmlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcmFuZCA9IHVuZGVmaW5lZDtcbiAgICB3aGlsZSAocmFuZCA9PT0gdW5kZWZpbmVkIHx8IG5vdFRoaXNJZHMuaW5kZXhPZihyYW5kKSA+IC0xKSB7XG4gICAgICAgIHJhbmQgPSBnZXRSYW5kb21JbnQoZGlzdHJpYnV0aW9uVGFibGUubGVuZ3RoKTtcbiAgICAgICAgcmFuZCA9IGRpc3RyaWJ1dGlvblRhYmxlW3JhbmRdO1xuICAgIH1cblxuICAgIHJldHVybiByYW5kO1xufVxuZXhwb3J0IGNsYXNzIENvbXBhbnkge1xuICAgIHByb2R1Y3RpZDogbnVtYmVyO1xuICAgIGJ1aWxkaW5nczogbnVtYmVyID0gMDtcbiAgICB3b3JrZXJzOiBudW1iZXIgPSAwO1xuICAgIGhhc0xpY2Vuc2UgPSBmYWxzZTtcbiAgICB0eXBlID0gXCJDb21wYW55XCI7XG4gICAgZGFpbHlQcm9kdWNlZFRvZGF5OiBudW1iZXI7XG4gICAgbGFzdFVwZGF0ZTogbnVtYmVyO1xuICAgIGNpdHk6IENpdHk7XG4gICAgLy8gc3RhdGljIHdvcmtlckluQ29tcGFueT0yMDtcbiAgICBjb25zdHJ1Y3Rvcihub3RUaGlzSWRzOiBudW1iZXJbXSA9IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLmRhaWx5UHJvZHVjZWRUb2RheSA9IDA7XG4gICAgICAgIHRoaXMucHJvZHVjdGlkID0gZ2V0UmFuZG9tQ29tcGFueVR5cGUobm90VGhpc0lkcyk7XG4gICAgICAgIHRoaXMuYnVpbGRpbmdzID0gMDsvLyBnZXRSYW5kb21JbnQoMykrMTtcbiAgICAgICAgdGhpcy53b3JrZXJzID0gcGFyYW1ldGVyLndvcmtlckluQ29tcGFueSAqIHRoaXMuYnVpbGRpbmdzO1xuICAgICAgICB0aGlzLmhhc0xpY2Vuc2UgPSAocGFyYW1ldGVyLmFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXS5kaXN0cmlidXRpb24gPD0gOCkgPyBmYWxzZSA6IHRydWU7XG5cbiAgICB9XG4gICAgZ2V0TWF4V29ya2VycygpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5idWlsZGluZ3MgKiBwYXJhbWV0ZXIud29ya2VySW5Db21wYW55O1xuICAgIH1cbiAgICBnZXREYWlseVByb2R1Y2UoKTogbnVtYmVyIHtcbiAgICAgICAgdmFyIHByb2R1Y2UgPSB0aGlzLndvcmtlcnMgKiBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdLmRhaWx5UHJvZHVjZSAvIHBhcmFtZXRlci53b3JrZXJJbkNvbXBhbnk7XG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHByb2R1Y2UpO1xuICAgIH1cbiAgICBnZXREYWlseUlucHV0MSgpOiBudW1iZXIge1xuICAgICAgICB2YXIgbmVlZHMgPSAwO1xuICAgICAgICB2YXIgcHJvZHVjdCA9IHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF07XG4gICAgICAgIGlmIChwcm9kdWN0LmlucHV0MSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB2YXIgcCA9IHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kdWN0LmlucHV0MV07XG4gICAgICAgICAgICBuZWVkcyA9IHRoaXMud29ya2VycyAqIHByb2R1Y3QuaW5wdXQxQW1vdW50IC8gcGFyYW1ldGVyLndvcmtlckluQ29tcGFueTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmVlZHM7XG4gICAgfVxuICAgIGdldERheWlseUNvc3RzKCl7XG4gICAgICAgIHZhciBmYWN0PTg7XG4gICAgICAgIGlmKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGlzdHJpYnV0aW9uPT09OCl7XG4gICAgICAgICAgICBmYWN0PTk7XG4gICAgICAgIH1cbiAgICAgICAgaWYocGFyYW1ldGVyLmFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXS5kaXN0cmlidXRpb249PT00KXtcbiAgICAgICAgICAgIGZhY3Q9MTA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodGhpcy53b3JrZXJzKmZhY3QvcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXS5kYWlseVByb2R1Y2UpO1xuICAgIH1cbiAgICBnZXRCdWlsZGluZ01hdGVyaWFsKCkge1xuICAgICAgICB2YXIgZmFjdCA9IDUgLSAocGFyYW1ldGVyLmFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXS5kaXN0cmlidXRpb24pIC8gNDtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIGZhY3QgKiAxNSxcbiAgICAgICAgICAgIGZhY3QgKiAxNV1cbiAgICB9XG4gICAgZ2V0QnVpbGRpbmdDb3N0cygpIHtcbiAgICAgICAgdmFyIGZhY3QgPSA1IC0gKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGlzdHJpYnV0aW9uKSAvIDQ7XG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcmFtZXRlci5yYXRlQnV5QnVpbGRpbmcqZmFjdCAqIDEwMDAwK01hdGgucm91bmQocGFyYW1ldGVyLnJhdGVCdXlCdWlsZGluZ0dyb3dGYWN0b3IqdGhpcy5idWlsZGluZ3MpKTtcbiAgICB9XG4gICAgZ2V0RGFpbHlJbnB1dDIoKTogbnVtYmVyIHtcbiAgICAgICAgdmFyIG5lZWRzID0gMDtcbiAgICAgICAgdmFyIHByb2R1Y3QgPSBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdO1xuICAgICAgICBpZiAocHJvZHVjdC5pbnB1dDIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbmVlZHMgPSB0aGlzLndvcmtlcnMgKiBwcm9kdWN0LmlucHV0MkFtb3VudCAvcGFyYW1ldGVyLndvcmtlckluQ29tcGFueTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmVlZHM7XG4gICAgfVxuICAgIHVwZGF0ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMubGFzdFVwZGF0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLmNpdHkud29ybGQuZ2FtZS5kYXRlLmdldFRpbWUoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVwZGF0ZVByb2R1Y3Rpb24oKTtcbiAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy5jaXR5LndvcmxkLmdhbWUuZGF0ZS5nZXRUaW1lKCk7XG4gICAgfVxuICAgIHVwZGF0ZVByb2R1Y3Rpb24oKSB7XG5cbiAgICAgICAgaWYgKHRoaXMud29ya2VycyA9PT0gMClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdmFyIGRheVByb2NlbnQgPSB0aGlzLmNpdHkud29ybGQuZ2FtZS5kYXRlLmdldEhvdXJzKCkgLyAyNDtcbiAgICAgIC8vICBpZiAodGhpcy5jaXR5LndvcmxkLmdhbWUuZGF0ZS5nZXREYXRlKCkgIT09IG5ldyBEYXRlKHRoaXMubGFzdFVwZGF0ZSkuZ2V0RGF0ZSgpKSB7XG4gICAgICAgIGlmKHRoaXMuY2l0eS53b3JsZC5nYW1lLmRhdGUuZ2V0SG91cnMoKT09PTIzKXtcbiAgICAgICAgICAgIGRheVByb2NlbnQgPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHByb2QgPSB0aGlzLnByb2R1Y3RpZDtcbiAgICAgICAgdmFyIHRvdGFsRGFpbHlQcm9kdWNlID0gTWF0aC5yb3VuZCh0aGlzLndvcmtlcnMgKiBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uZGFpbHlQcm9kdWNlIC8gcGFyYW1ldGVyLndvcmtlckluQ29tcGFueSk7XG4gICAgICAgIHZhciB0b3RhbERhaWx5TmVlZDEgPSB1bmRlZmluZWQ7XG4gICAgICAgIHZhciB0b3RhbERhaWx5TmVlZDIgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQxIT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgdG90YWxEYWlseU5lZWQxID0gTWF0aC5yb3VuZCh0aGlzLndvcmtlcnMgKiBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQxQW1vdW50IC8gcGFyYW1ldGVyLndvcmtlckluQ29tcGFueSk7XG4gICAgICAgIGlmIChwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyIT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgdG90YWxEYWlseU5lZWQyID0gTWF0aC5yb3VuZCh0aGlzLndvcmtlcnMgKiBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyQW1vdW50IC8gcGFyYW1ldGVyLndvcmtlckluQ29tcGFueSk7XG5cbiAgICAgICAgaWYgKHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ID09PSAwICYmIHRvdGFsRGFpbHlOZWVkMSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAodG90YWxEYWlseU5lZWQxID49IHRoaXMuY2l0eS5zaG9wW3BhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDFdKSB7XG4gICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh0b3RhbERhaWx5TmVlZDEgKyBcInhcIiArIHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDEgKyBcIiBuZWVkZWRcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmRhaWx5UHJvZHVjZWRUb2RheSA9PT0gMCAmJiB0b3RhbERhaWx5TmVlZDIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKHRvdGFsRGFpbHlOZWVkMiA+PSB0aGlzLmNpdHkuc2hvcFtwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyXSkge1xuICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2codG90YWxEYWlseU5lZWQyICsgXCJ4XCIgKyBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyICsgXCIgbmVlZGVkXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgdW50aWxOb3cgPSBNYXRoLnJvdW5kKHRvdGFsRGFpbHlQcm9kdWNlICogZGF5UHJvY2VudCk7XG4gICAgICAgIGlmICh1bnRpbE5vdyA+IHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5KSB7XG4gICAgICAgICAgICB2YXIgZGlmZiA9IHVudGlsTm93IC0gdGhpcy5kYWlseVByb2R1Y2VkVG9kYXk7XG4gICAgICAgICAgICBpZiAoZGlmZiA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvdGFsRGFpbHlOZWVkMSAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2l0eS5zaG9wW3BhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDFdIC09IHRvdGFsRGFpbHlOZWVkMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Z05lZWRbcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MV0rPXRvdGFsRGFpbHlOZWVkMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodG90YWxEYWlseU5lZWQyICE9PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXR5LnNob3BbcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0Ml0gLT0gdG90YWxEYWlseU5lZWQyO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWdOZWVkW3BhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDJdKz10b3RhbERhaWx5TmVlZDI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5jaXR5LnNob3BbcHJvZF0gKz0gZGlmZjtcbiAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGRpZmYgKyBcInhcIiArIHByb2QgKyBcIiBwcm9kdWNlZFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRhaWx5UHJvZHVjZWRUb2RheSA9IHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ICsgZGlmZjtcbiAgICAgICAgICAgIH1cblxuXG5cbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF5UHJvY2VudCA9PT0gMSkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInByb2QgXCIrdGhpcy5wcm9kdWN0aWQrIFwiIFwiK3RoaXMuZGFpbHlQcm9kdWNlZFRvZGF5KTtcblxuICAgICAgICAgICAgdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgPSAwO1xuICAgICAgICB9XG4gICAgfVxuXG59XG5leHBvcnQgZnVuY3Rpb24gdGVzdCgpIHtcbiAgICB2YXIgaWRzID0gW107XG4gICAgdmFyIHQgPSBbXTtcbiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHBhcmFtZXRlci5hbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICB2YXIgaCA9IG5ldyBDb21wYW55KGlkcyk7XG4gICAgICAgIGlkcy5wdXNoKGgucHJvZHVjdGlkKTtcbiAgICAgICAgdC5wdXNoKGgucHJvZHVjdGlkKTtcbiAgICB9XG4gICAgdC5zb3J0KCk7XG4gICAgZm9yICh2YXIgeCA9IDA7IHggPCB0Lmxlbmd0aDsgeCsrKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKHRbeF0pO1xuICAgIH1cbn0iXX0=