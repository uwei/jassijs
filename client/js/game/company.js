define(["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.test = exports.Company = exports.debugNeed = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    var distributionTable = undefined;
    var debugNeed = [];
    exports.debugNeed = debugNeed;
    for (var x = 0; x < 19; x++) {
        debugNeed.push(0);
    }
    function getRandomCompanyType(notThisIds = undefined) {
        if (notThisIds === undefined)
            notThisIds = [];
        if (!distributionTable) {
            distributionTable = [];
            var distCount = 0;
            for (var x = 0; x < parameter.allProducts.length; x++) {
                for (var y = 0; y < parameter.allProducts[x].distribution; y++) {
                    distributionTable.push(parameter.allProducts[x].id);
                }
            }
        }
        var rand = undefined;
        while (rand === undefined || notThisIds.indexOf(rand) > -1) {
            rand = getRandomInt(distributionTable.length);
            rand = distributionTable[rand];
        }
        return rand;
    }
    class Company {
        // static workerInCompany=20;
        constructor(notThisIds = undefined) {
            this.buildings = 0;
            this.workers = 0;
            this.hasLicense = false;
            this.type = "Company";
            this.dailyProducedToday = 0;
            this.productid = getRandomCompanyType(notThisIds);
            this.buildings = 0; // getRandomInt(3)+1;
            this.workers = parameter.workerInCompany * this.buildings;
            this.hasLicense = (parameter.allProducts[this.productid].distribution <= 8) ? false : true;
        }
        getMaxWorkers() {
            return this.buildings * parameter.workerInCompany;
        }
        getDailyProduce() {
            var produce = this.workers * parameter.allProducts[this.productid].dailyProduce / parameter.workerInCompany;
            return Math.round(produce);
        }
        getDailyInput1() {
            var needs = 0;
            var product = parameter.allProducts[this.productid];
            if (product.input1 !== undefined) {
                var p = parameter.allProducts[product.input1];
                needs = this.workers * product.input1Amount / parameter.workerInCompany;
            }
            return needs;
        }
        getDayilyCosts() {
            var fact = 8;
            if (parameter.allProducts[this.productid].distribution === 8) {
                fact = 9;
            }
            if (parameter.allProducts[this.productid].distribution === 4) {
                fact = 10;
            }
            return Math.round(this.workers * fact / parameter.allProducts[this.productid].dailyProduce);
        }
        getBuildingMaterial() {
            var fact = 5 - (parameter.allProducts[this.productid].distribution) / 4;
            return [
                fact * 15,
                fact * 15
            ];
        }
        getBuildingCosts() {
            var fact = 5 - (parameter.allProducts[this.productid].distribution) / 4;
            var buildings = this.buildings + this.city.getBuildingInProgress(this.productid);
            return Math.round(parameter.rateBuyBuilding * fact * 10000 + Math.round(parameter.rateBuyBuildingGrowFactor * buildings));
        }
        getDailyInput2() {
            var needs = 0;
            var product = parameter.allProducts[this.productid];
            if (product.input2 !== undefined) {
                needs = this.workers * product.input2Amount / parameter.workerInCompany;
            }
            return needs;
        }
        update() {
            if (this.lastUpdate === undefined) {
                this.lastUpdate = this.city.world.game.date.getTime();
            }
            this.updateProduction();
            this.lastUpdate = this.city.world.game.date.getTime();
        }
        updateProduction() {
            if (this.workers === 0)
                return;
            var dayProcent = this.city.world.game.date.getHours() / 24;
            //  if (this.city.world.game.date.getDate() !== new Date(this.lastUpdate).getDate()) {
            if (this.city.world.game.date.getHours() === 23) {
                dayProcent = 1;
            }
            var prod = this.productid;
            var totalDailyProduce = Math.round(this.workers * parameter.allProducts[prod].dailyProduce / parameter.workerInCompany);
            var totalDailyNeed1 = undefined;
            var totalDailyNeed2 = undefined;
            if (parameter.allProducts[prod].input1 !== undefined)
                totalDailyNeed1 = Math.round(this.workers * parameter.allProducts[prod].input1Amount / parameter.workerInCompany);
            if (parameter.allProducts[prod].input2 !== undefined)
                totalDailyNeed2 = Math.round(this.workers * parameter.allProducts[prod].input2Amount / parameter.workerInCompany);
            if (this.dailyProducedToday === 0 && totalDailyNeed1 !== undefined) {
                if (totalDailyNeed1 >= this.city.shop[parameter.allProducts[prod].input1]) {
                    // console.log(totalDailyNeed1 + "x" + parameter.allProducts[prod].input1 + " needed");
                    return;
                }
                else {
                }
            }
            if (this.dailyProducedToday === 0 && totalDailyNeed2 !== undefined) {
                if (totalDailyNeed2 >= this.city.shop[parameter.allProducts[prod].input2]) {
                    // console.log(totalDailyNeed2 + "x" + parameter.allProducts[prod].input2 + " needed");
                    return;
                }
            }
            var untilNow = Math.round(totalDailyProduce * dayProcent);
            if (untilNow > this.dailyProducedToday) {
                var diff = untilNow - this.dailyProducedToday;
                if (diff > 0) {
                    if (this.dailyProducedToday === 0) {
                        if (totalDailyNeed1 !== undefined) {
                            this.city.shop[parameter.allProducts[prod].input1] -= totalDailyNeed1;
                            debugNeed[parameter.allProducts[prod].input1] += totalDailyNeed1;
                        }
                        if (totalDailyNeed2 !== undefined) {
                            this.city.shop[parameter.allProducts[prod].input2] -= totalDailyNeed2;
                            debugNeed[parameter.allProducts[prod].input2] += totalDailyNeed2;
                        }
                    }
                    this.city.shop[prod] += diff;
                    // console.log(diff + "x" + prod + " produced");
                    this.dailyProducedToday = this.dailyProducedToday + diff;
                }
            }
            if (dayProcent === 1) {
                //console.log("prod "+this.productid+ " "+this.dailyProducedToday);
                this.dailyProducedToday = 0;
            }
        }
    }
    exports.Company = Company;
    function test() {
        var ids = [];
        var t = [];
        for (var x = 0; x < parameter.allProducts.length; x++) {
            var h = new Company(ids);
            ids.push(h.productid);
            t.push(h.productid);
        }
        t.sort();
        for (var x = 0; x < t.length; x++) {
            console.log(t[x]);
        }
    }
    exports.test = test;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGFueS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2dhbWUvY29tcGFueS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0lBR0EsU0FBUyxZQUFZLENBQUMsR0FBRztRQUNyQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFDRCxJQUFJLGlCQUFpQixHQUFhLFNBQVMsQ0FBQztJQUM1QyxJQUFJLFNBQVMsR0FBQyxFQUFFLENBQUM7SUFJVCw4QkFBUztJQUhqQixLQUFJLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBQyxDQUFDLEdBQUMsRUFBRSxFQUFDLENBQUMsRUFBRSxFQUFDO1FBQ2pCLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDckI7SUFFRCxTQUFTLG9CQUFvQixDQUFDLGFBQXVCLFNBQVM7UUFDMUQsSUFBSSxVQUFVLEtBQUssU0FBUztZQUN4QixVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUNwQixpQkFBaUIsR0FBRyxFQUFFLENBQUM7WUFDdkIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUM1RCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDdkQ7YUFDSjtTQUNKO1FBQ0QsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxLQUFLLFNBQVMsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ3hELElBQUksR0FBRyxZQUFZLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDOUMsSUFBSSxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELE1BQWEsT0FBTztRQVNoQiw2QkFBNkI7UUFDN0IsWUFBWSxhQUF1QixTQUFTO1lBUjVDLGNBQVMsR0FBVyxDQUFDLENBQUM7WUFDdEIsWUFBTyxHQUFXLENBQUMsQ0FBQztZQUNwQixlQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ25CLFNBQUksR0FBRyxTQUFTLENBQUM7WUFNYixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxTQUFTLEdBQUcsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQSxxQkFBcUI7WUFDeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDMUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFFL0YsQ0FBQztRQUNELGFBQWE7WUFDVCxPQUFPLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQztRQUN0RCxDQUFDO1FBQ0QsZUFBZTtZQUNYLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUM7WUFDNUcsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFDRCxjQUFjO1lBQ1YsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2QsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDcEQsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzlDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQzthQUMzRTtZQUNELE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxjQUFjO1lBQ1YsSUFBSSxJQUFJLEdBQUMsQ0FBQyxDQUFDO1lBQ1gsSUFBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLEtBQUcsQ0FBQyxFQUFDO2dCQUN0RCxJQUFJLEdBQUMsQ0FBQyxDQUFDO2FBQ1Y7WUFDRCxJQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksS0FBRyxDQUFDLEVBQUM7Z0JBQ3RELElBQUksR0FBQyxFQUFFLENBQUM7YUFDWDtZQUNELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFDLElBQUksR0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM1RixDQUFDO1FBQ0QsbUJBQW1CO1lBQ2YsSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hFLE9BQU87Z0JBQ0gsSUFBSSxHQUFHLEVBQUU7Z0JBQ1QsSUFBSSxHQUFHLEVBQUU7YUFBQyxDQUFBO1FBQ2xCLENBQUM7UUFDRCxnQkFBZ0I7WUFDWixJQUFJLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEUsSUFBSSxTQUFTLEdBQUMsSUFBSSxDQUFDLFNBQVMsR0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM3RSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLGVBQWUsR0FBQyxJQUFJLEdBQUcsS0FBSyxHQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLHlCQUF5QixHQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDeEgsQ0FBQztRQUNELGNBQWM7WUFDVixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7WUFDZCxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssU0FBUyxFQUFFO2dCQUM5QixLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxHQUFFLFNBQVMsQ0FBQyxlQUFlLENBQUM7YUFDMUU7WUFDRCxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDO1FBQ0QsTUFBTTtZQUNGLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxTQUFTLEVBQUU7Z0JBQy9CLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUN6RDtZQUNELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMxRCxDQUFDO1FBQ0QsZ0JBQWdCO1lBRVosSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLENBQUM7Z0JBQ2xCLE9BQU87WUFDWCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUM3RCxzRkFBc0Y7WUFDcEYsSUFBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFHLEVBQUUsRUFBQztnQkFDekMsVUFBVSxHQUFHLENBQUMsQ0FBQzthQUNsQjtZQUVELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDMUIsSUFBSSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3hILElBQUksZUFBZSxHQUFHLFNBQVMsQ0FBQztZQUNoQyxJQUFJLGVBQWUsR0FBRyxTQUFTLENBQUM7WUFDaEMsSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBRyxTQUFTO2dCQUM5QyxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUN0SCxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFHLFNBQVM7Z0JBQzlDLGVBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBRXRILElBQUksSUFBSSxDQUFDLGtCQUFrQixLQUFLLENBQUMsSUFBSSxlQUFlLEtBQUssU0FBUyxFQUFFO2dCQUNoRSxJQUFJLGVBQWUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUN4RSx1RkFBdUY7b0JBQ3RGLE9BQU87aUJBQ1Y7cUJBQU07aUJBRU47YUFDSjtZQUNELElBQUksSUFBSSxDQUFDLGtCQUFrQixLQUFLLENBQUMsSUFBSSxlQUFlLEtBQUssU0FBUyxFQUFFO2dCQUNoRSxJQUFJLGVBQWUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUN4RSx1RkFBdUY7b0JBQ3RGLE9BQU87aUJBQ1Y7YUFDSjtZQUNELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxDQUFDLENBQUM7WUFDMUQsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFO2dCQUNwQyxJQUFJLElBQUksR0FBRyxRQUFRLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDO2dCQUM5QyxJQUFJLElBQUksR0FBRyxDQUFDLEVBQUU7b0JBQ1YsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEtBQUssQ0FBQyxFQUFFO3dCQUMvQixJQUFJLGVBQWUsS0FBSyxTQUFTLEVBQUM7NEJBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksZUFBZSxDQUFDOzRCQUNyRSxTQUFTLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBRSxlQUFlLENBQUM7eUJBQ25FO3dCQUNELElBQUksZUFBZSxLQUFLLFNBQVMsRUFBQzs0QkFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxlQUFlLENBQUM7NEJBQ3RFLFNBQVMsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFFLGVBQWUsQ0FBQzt5QkFDbEU7cUJBQ0o7b0JBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO29CQUM5QixnREFBZ0Q7b0JBQy9DLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO2lCQUM1RDthQUlKO1lBQ0QsSUFBSSxVQUFVLEtBQUssQ0FBQyxFQUFFO2dCQUNsQixtRUFBbUU7Z0JBRW5FLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7YUFDL0I7UUFDTCxDQUFDO0tBRUo7SUFwSUQsMEJBb0lDO0lBQ0QsU0FBZ0IsSUFBSTtRQUNoQixJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDWCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkQsSUFBSSxDQUFDLEdBQUcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekIsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDdkI7UUFDRCxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDVCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQVpELG9CQVlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSWNvbnMgfSBmcm9tIFwiZ2FtZS9pY29uc1wiO1xuaW1wb3J0IHsgQ2l0eSB9IGZyb20gXCJnYW1lL2NpdHlcIjtcblxuZnVuY3Rpb24gZ2V0UmFuZG9tSW50KG1heCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXgpO1xufVxudmFyIGRpc3RyaWJ1dGlvblRhYmxlOiBudW1iZXJbXSA9IHVuZGVmaW5lZDtcbnZhciBkZWJ1Z05lZWQ9W107XG5mb3IodmFyIHg9MDt4PDE5O3grKyl7XG4gICAgZGVidWdOZWVkLnB1c2goMCk7XG59XG5leHBvcnQge2RlYnVnTmVlZH07XG5mdW5jdGlvbiBnZXRSYW5kb21Db21wYW55VHlwZShub3RUaGlzSWRzOiBudW1iZXJbXSA9IHVuZGVmaW5lZCkge1xuICAgIGlmIChub3RUaGlzSWRzID09PSB1bmRlZmluZWQpXG4gICAgICAgIG5vdFRoaXNJZHMgPSBbXTtcbiAgICBpZiAoIWRpc3RyaWJ1dGlvblRhYmxlKSB7XG4gICAgICAgIGRpc3RyaWJ1dGlvblRhYmxlID0gW107XG4gICAgICAgIHZhciBkaXN0Q291bnQgPSAwO1xuICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHBhcmFtZXRlci5hbGxQcm9kdWN0cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbeF0uZGlzdHJpYnV0aW9uOyB5KyspIHtcbiAgICAgICAgICAgICAgICBkaXN0cmlidXRpb25UYWJsZS5wdXNoKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t4XS5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHJhbmQgPSB1bmRlZmluZWQ7XG4gICAgd2hpbGUgKHJhbmQgPT09IHVuZGVmaW5lZCB8fCBub3RUaGlzSWRzLmluZGV4T2YocmFuZCkgPiAtMSkge1xuICAgICAgICByYW5kID0gZ2V0UmFuZG9tSW50KGRpc3RyaWJ1dGlvblRhYmxlLmxlbmd0aCk7XG4gICAgICAgIHJhbmQgPSBkaXN0cmlidXRpb25UYWJsZVtyYW5kXTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmFuZDtcbn1cbmV4cG9ydCBjbGFzcyBDb21wYW55IHtcbiAgICBwcm9kdWN0aWQ6IG51bWJlcjtcbiAgICBidWlsZGluZ3M6IG51bWJlciA9IDA7XG4gICAgd29ya2VyczogbnVtYmVyID0gMDtcbiAgICBoYXNMaWNlbnNlID0gZmFsc2U7XG4gICAgdHlwZSA9IFwiQ29tcGFueVwiO1xuICAgIGRhaWx5UHJvZHVjZWRUb2RheTogbnVtYmVyO1xuICAgIGxhc3RVcGRhdGU6IG51bWJlcjtcbiAgICBjaXR5OiBDaXR5O1xuICAgIC8vIHN0YXRpYyB3b3JrZXJJbkNvbXBhbnk9MjA7XG4gICAgY29uc3RydWN0b3Iobm90VGhpc0lkczogbnVtYmVyW10gPSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgPSAwO1xuICAgICAgICB0aGlzLnByb2R1Y3RpZCA9IGdldFJhbmRvbUNvbXBhbnlUeXBlKG5vdFRoaXNJZHMpO1xuICAgICAgICB0aGlzLmJ1aWxkaW5ncyA9IDA7Ly8gZ2V0UmFuZG9tSW50KDMpKzE7XG4gICAgICAgIHRoaXMud29ya2VycyA9IHBhcmFtZXRlci53b3JrZXJJbkNvbXBhbnkgKiB0aGlzLmJ1aWxkaW5ncztcbiAgICAgICAgdGhpcy5oYXNMaWNlbnNlID0gKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGlzdHJpYnV0aW9uIDw9IDgpID8gZmFsc2UgOiB0cnVlO1xuXG4gICAgfVxuICAgIGdldE1heFdvcmtlcnMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRpbmdzICogcGFyYW1ldGVyLndvcmtlckluQ29tcGFueTtcbiAgICB9XG4gICAgZ2V0RGFpbHlQcm9kdWNlKCk6IG51bWJlciB7XG4gICAgICAgIHZhciBwcm9kdWNlID0gdGhpcy53b3JrZXJzICogcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3RoaXMucHJvZHVjdGlkXS5kYWlseVByb2R1Y2UgLyBwYXJhbWV0ZXIud29ya2VySW5Db21wYW55O1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChwcm9kdWNlKTtcbiAgICB9XG4gICAgZ2V0RGFpbHlJbnB1dDEoKTogbnVtYmVyIHtcbiAgICAgICAgdmFyIG5lZWRzID0gMDtcbiAgICAgICAgdmFyIHByb2R1Y3QgPSBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdO1xuICAgICAgICBpZiAocHJvZHVjdC5pbnB1dDEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdmFyIHAgPSBwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZHVjdC5pbnB1dDFdO1xuICAgICAgICAgICAgbmVlZHMgPSB0aGlzLndvcmtlcnMgKiBwcm9kdWN0LmlucHV0MUFtb3VudCAvIHBhcmFtZXRlci53b3JrZXJJbkNvbXBhbnk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5lZWRzO1xuICAgIH1cbiAgICBnZXREYXlpbHlDb3N0cygpe1xuICAgICAgICB2YXIgZmFjdD04O1xuICAgICAgICBpZihwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdLmRpc3RyaWJ1dGlvbj09PTgpe1xuICAgICAgICAgICAgZmFjdD05O1xuICAgICAgICB9XG4gICAgICAgIGlmKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGlzdHJpYnV0aW9uPT09NCl7XG4gICAgICAgICAgICBmYWN0PTEwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMud29ya2VycypmYWN0L3BhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGFpbHlQcm9kdWNlKTtcbiAgICB9XG4gICAgZ2V0QnVpbGRpbmdNYXRlcmlhbCgpIHtcbiAgICAgICAgdmFyIGZhY3QgPSA1IC0gKHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF0uZGlzdHJpYnV0aW9uKSAvIDQ7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICBmYWN0ICogMTUsXG4gICAgICAgICAgICBmYWN0ICogMTVdXG4gICAgfVxuICAgIGdldEJ1aWxkaW5nQ29zdHMoKSB7XG4gICAgICAgIHZhciBmYWN0ID0gNSAtIChwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbdGhpcy5wcm9kdWN0aWRdLmRpc3RyaWJ1dGlvbikgLyA0O1xuICAgICAgICB2YXIgYnVpbGRpbmdzPXRoaXMuYnVpbGRpbmdzK3RoaXMuY2l0eS5nZXRCdWlsZGluZ0luUHJvZ3Jlc3ModGhpcy5wcm9kdWN0aWQpO1xuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChwYXJhbWV0ZXIucmF0ZUJ1eUJ1aWxkaW5nKmZhY3QgKiAxMDAwMCtNYXRoLnJvdW5kKHBhcmFtZXRlci5yYXRlQnV5QnVpbGRpbmdHcm93RmFjdG9yKmJ1aWxkaW5ncykpO1xuICAgIH1cbiAgICBnZXREYWlseUlucHV0MigpOiBudW1iZXIge1xuICAgICAgICB2YXIgbmVlZHMgPSAwO1xuICAgICAgICB2YXIgcHJvZHVjdCA9IHBhcmFtZXRlci5hbGxQcm9kdWN0c1t0aGlzLnByb2R1Y3RpZF07XG4gICAgICAgIGlmIChwcm9kdWN0LmlucHV0MiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBuZWVkcyA9IHRoaXMud29ya2VycyAqIHByb2R1Y3QuaW5wdXQyQW1vdW50IC9wYXJhbWV0ZXIud29ya2VySW5Db21wYW55O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZWVkcztcbiAgICB9XG4gICAgdXBkYXRlKCkge1xuICAgICAgICBpZiAodGhpcy5sYXN0VXBkYXRlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMubGFzdFVwZGF0ZSA9IHRoaXMuY2l0eS53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXBkYXRlUHJvZHVjdGlvbigpO1xuICAgICAgICB0aGlzLmxhc3RVcGRhdGUgPSB0aGlzLmNpdHkud29ybGQuZ2FtZS5kYXRlLmdldFRpbWUoKTtcbiAgICB9XG4gICAgdXBkYXRlUHJvZHVjdGlvbigpIHtcblxuICAgICAgICBpZiAodGhpcy53b3JrZXJzID09PSAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB2YXIgZGF5UHJvY2VudCA9IHRoaXMuY2l0eS53b3JsZC5nYW1lLmRhdGUuZ2V0SG91cnMoKSAvIDI0O1xuICAgICAgLy8gIGlmICh0aGlzLmNpdHkud29ybGQuZ2FtZS5kYXRlLmdldERhdGUoKSAhPT0gbmV3IERhdGUodGhpcy5sYXN0VXBkYXRlKS5nZXREYXRlKCkpIHtcbiAgICAgICAgaWYodGhpcy5jaXR5LndvcmxkLmdhbWUuZGF0ZS5nZXRIb3VycygpPT09MjMpe1xuICAgICAgICAgICAgZGF5UHJvY2VudCA9IDE7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgcHJvZCA9IHRoaXMucHJvZHVjdGlkO1xuICAgICAgICB2YXIgdG90YWxEYWlseVByb2R1Y2UgPSBNYXRoLnJvdW5kKHRoaXMud29ya2VycyAqIHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5kYWlseVByb2R1Y2UgLyBwYXJhbWV0ZXIud29ya2VySW5Db21wYW55KTtcbiAgICAgICAgdmFyIHRvdGFsRGFpbHlOZWVkMSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdmFyIHRvdGFsRGFpbHlOZWVkMiA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDEhPT11bmRlZmluZWQpXG4gICAgICAgICAgICB0b3RhbERhaWx5TmVlZDEgPSBNYXRoLnJvdW5kKHRoaXMud29ya2VycyAqIHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDFBbW91bnQgLyBwYXJhbWV0ZXIud29ya2VySW5Db21wYW55KTtcbiAgICAgICAgaWYgKHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDIhPT11bmRlZmluZWQpXG4gICAgICAgICAgICB0b3RhbERhaWx5TmVlZDIgPSBNYXRoLnJvdW5kKHRoaXMud29ya2VycyAqIHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDJBbW91bnQgLyBwYXJhbWV0ZXIud29ya2VySW5Db21wYW55KTtcblxuICAgICAgICBpZiAodGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgPT09IDAgJiYgdG90YWxEYWlseU5lZWQxICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlmICh0b3RhbERhaWx5TmVlZDEgPj0gdGhpcy5jaXR5LnNob3BbcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MV0pIHtcbiAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHRvdGFsRGFpbHlOZWVkMSArIFwieFwiICsgcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MSArIFwiIG5lZWRlZFwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ID09PSAwICYmIHRvdGFsRGFpbHlOZWVkMiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAodG90YWxEYWlseU5lZWQyID49IHRoaXMuY2l0eS5zaG9wW3BhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDJdKSB7XG4gICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh0b3RhbERhaWx5TmVlZDIgKyBcInhcIiArIHBhcmFtZXRlci5hbGxQcm9kdWN0c1twcm9kXS5pbnB1dDIgKyBcIiBuZWVkZWRcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciB1bnRpbE5vdyA9IE1hdGgucm91bmQodG90YWxEYWlseVByb2R1Y2UgKiBkYXlQcm9jZW50KTtcbiAgICAgICAgaWYgKHVudGlsTm93ID4gdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkpIHtcbiAgICAgICAgICAgIHZhciBkaWZmID0gdW50aWxOb3cgLSB0aGlzLmRhaWx5UHJvZHVjZWRUb2RheTtcbiAgICAgICAgICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhaWx5UHJvZHVjZWRUb2RheSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodG90YWxEYWlseU5lZWQxICE9PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXR5LnNob3BbcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0MV0gLT0gdG90YWxEYWlseU5lZWQxO1xuICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnTmVlZFtwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQxXSs9dG90YWxEYWlseU5lZWQxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3RhbERhaWx5TmVlZDIgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNpdHkuc2hvcFtwYXJhbWV0ZXIuYWxsUHJvZHVjdHNbcHJvZF0uaW5wdXQyXSAtPSB0b3RhbERhaWx5TmVlZDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Z05lZWRbcGFyYW1ldGVyLmFsbFByb2R1Y3RzW3Byb2RdLmlucHV0Ml0rPXRvdGFsRGFpbHlOZWVkMjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmNpdHkuc2hvcFtwcm9kXSArPSBkaWZmO1xuICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZGlmZiArIFwieFwiICsgcHJvZCArIFwiIHByb2R1Y2VkXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGFpbHlQcm9kdWNlZFRvZGF5ID0gdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkgKyBkaWZmO1xuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9XG4gICAgICAgIGlmIChkYXlQcm9jZW50ID09PSAxKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwicHJvZCBcIit0aGlzLnByb2R1Y3RpZCsgXCIgXCIrdGhpcy5kYWlseVByb2R1Y2VkVG9kYXkpO1xuXG4gICAgICAgICAgICB0aGlzLmRhaWx5UHJvZHVjZWRUb2RheSA9IDA7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0KCkge1xuICAgIHZhciBpZHMgPSBbXTtcbiAgICB2YXIgdCA9IFtdO1xuICAgIGZvciAodmFyIHggPSAwOyB4IDwgcGFyYW1ldGVyLmFsbFByb2R1Y3RzLmxlbmd0aDsgeCsrKSB7XG4gICAgICAgIHZhciBoID0gbmV3IENvbXBhbnkoaWRzKTtcbiAgICAgICAgaWRzLnB1c2goaC5wcm9kdWN0aWQpO1xuICAgICAgICB0LnB1c2goaC5wcm9kdWN0aWQpO1xuICAgIH1cbiAgICB0LnNvcnQoKTtcbiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHQubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgY29uc29sZS5sb2codFt4XSk7XG4gICAgfVxufSJdfQ==