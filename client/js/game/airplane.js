define(["require", "exports", "game/product", "game/airplanedialog"], function (require, exports, product_1, airplanedialog_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Airplane = void 0;
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }
    class Airplane {
        constructor(world) {
            this.status = "";
            this.activeRoute = 0;
            this.world = world;
            this.route = [];
            /*  for(var x=0;x<4;x++){
                  var rt=new Route();
                  rt.cityid=x;
                  this.route.push(rt);
              }*/
        }
        create() {
            var _this = this;
            this.dom = document.createRange().createContextualFragment("<span style='transform:rotate(0turn)' class='mdi mdi-airplane'></span>").children[0]; //document.createElement("span");
            this.dom.style.position = "absolute";
            this.x = getRandomInt(this.world.game.mapWidth);
            this.y = getRandomInt(this.world.game.mapHeight);
            this.action = "wait";
            this.products = [];
            for (var x = 0; x < product_1.allProducts.length; x++) {
                this.products[x] = 0;
            }
            this.dom.addEventListener("click", (ev) => {
                _this.onclick(ev);
                return undefined;
            });
            this.lastUpdate = this.world.game.date.getTime();
            this.update();
        }
        flyTo(city) {
            var x = city.x;
            var y = city.y;
            this.lastUpdate = this.world.game.date.getTime();
            console.log("fly to " + city.name);
            this.action = "fly";
            this.status = "fly to " + city.name;
            this.targetX = x;
            this.targetY = y;
            this.update();
            for (var i = 0; i < this.world.cities.length; i++) {
                var pos = this.world.cities[i].airplanesInCity.indexOf(this);
                if (pos !== -1) {
                    this.world.cities[i].airplanesInCity.splice(pos, 1);
                }
            }
        }
        select() {
            this.dom.style.color = "red";
        }
        unselect() {
            this.dom.style.color = "black";
        }
        arrived() {
            var _a;
            console.log("target arrived");
            this.targetX = undefined;
            this.targetY = undefined;
            this.action = "wait";
            this.status = "";
            (_a = this.world.findCityAt(this.x, this.y)) === null || _a === void 0 ? void 0 : _a.airplanesInCity.push(this);
            this.dom.style.transform = "rotate(0deg)";
            if (this.activeRoute !== -1) {
                console.log("unload now");
                this.action = "unload";
                this.status = "unload";
                this.lastAction = this.lastUpdate;
            }
        }
        calcNewPosition() {
            var pixelToTarget = Math.round(Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2))); //Pytharoras
            var fromX = this.x;
            var fromY = this.y;
            var fromTime = 0;
            var toX = this.targetX;
            var toY = this.targetY;
            var toTime = pixelToTarget / this.speed; //t=s/v; in Tage
            var speedVectorX = toX - fromX;
            var speedVectorY = toY - fromY;
            var speedVectorTime = (toTime - fromTime);
            var nowTime = (this.world.game.date.getTime() - this.lastUpdate) / (1000 * 60 * 60 * 24);
            var nowX = Math.round((nowTime / speedVectorTime) * speedVectorX + fromX);
            var nowY = Math.round((nowTime / speedVectorTime) * speedVectorY + fromY);
            if (nowTime >= toTime) {
                this.x = this.targetX;
                this.y = this.targetY;
                this.arrived();
            }
            else {
                var rad = Math.atan((fromX - toX) / (fromY - toY));
                var winkel = 0;
                if (fromY > toY) {
                    winkel = 360 - rad * (180) / Math.PI;
                }
                else {
                    winkel = 180 - rad * (180) / Math.PI;
                }
                var s = ("" + winkel).replace(",", ".");
                this.dom.style.transform = "rotate(" + s + "deg)";
                // console.log(pixelToTarget+" pixel in "+toTime+" seconds. Position "+nowX+" "+nowY+" lastupdate "+nowTime+" "+winkel+"Â°");
                this.x = nowX;
                this.y = nowY;
            }
        }
        update() {
            if (this.targetX !== undefined) {
                this.calcNewPosition();
            }
            this.lastUpdate = this.world.game.date.getTime();
            this.dom.style.top = this.y + "px";
            this.dom.style.left = (this.x - 15) + "px";
            if (this.activeRoute !== -1 && this.route.length > 1) {
                if (this.action === "unload" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    console.log("load now");
                    this.action = "load";
                    this.status = "load";
                    this.lastAction = this.lastUpdate;
                }
                if (this.action === "load" && (this.lastUpdate - this.lastAction) > (3 * 1000 * 60 * 60)) {
                    this.activeRoute++;
                    if (this.activeRoute === this.route.length)
                        this.activeRoute = 0;
                    var city = this.world.cities[this.route[this.activeRoute].cityid];
                    this.flyTo(city);
                    this.lastAction = this.lastUpdate;
                }
            }
        }
        onclick(th) {
            var _a;
            th.preventDefault();
            th.stopPropagation();
            console.log(this.name);
            (_a = this.world.selection) === null || _a === void 0 ? void 0 : _a.unselect();
            this.world.selection = this;
            this.select();
            var h = airplanedialog_1.AirplaneDialog.getInstance();
            h.airplane = this;
            h.show();
        }
    }
    exports.Airplane = Airplane;
});
//<span style='font-size:100px;'>&#9951;</span>
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlycGxhbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9nYW1lL2FpcnBsYW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7SUFNQSxTQUFTLFlBQVksQ0FBQyxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELE1BQWEsUUFBUTtRQWlCakIsWUFBWSxLQUFZO1lBSHhCLFdBQU0sR0FBVyxFQUFFLENBQUM7WUFFcEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7WUFFWixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNoQjs7OztpQkFJSztRQUNULENBQUM7UUFDRCxNQUFNO1lBQ0YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQVEsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLHdCQUF3QixDQUFDLHdFQUF3RSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEsaUNBQWlDO1lBQ3ZMLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFDckMsSUFBSSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHFC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Q0FBQyxHQUFHLElBQUksR0FBQyxFQUFFLEdBQUMsRUFBRSxDQUFDLEVBQUU7b0JBQzlFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztvQkFDbkIsSUFBRyxJQUFJLENBQUMsV0FBVyxLQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTt3QkFDbkMsSUFBSSxDQUFDLFdBQVcsR0FBQyxDQUFDLENBQUM7b0JBQ3ZCLElBQUksSUFBSSxHQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7aUJBQ3JDO2FBQ0o7UUFDTCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEVBQWM7O1lBQ2xCLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNwQixFQUFFLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkIsTUFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsMENBQUUsUUFBUSxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNkLElBQUksQ0FBQyxHQUFHLCtCQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFDbEIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWIsQ0FBQztLQUNKO0lBNUpELDRCQTRKQzs7QUFFRCwrQ0FBK0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBXb3JsZCB9IGZyb20gXCJnYW1lL3dvcmxkXCI7XG5pbXBvcnQgeyBhbGxQcm9kdWN0cyB9IGZyb20gXCJnYW1lL3Byb2R1Y3RcIjtcbmltcG9ydCB7IEFpcnBsYW5lRGlhbG9nIH0gZnJvbSBcImdhbWUvYWlycGxhbmVkaWFsb2dcIjtcbmltcG9ydCB7IFJvdXRlIH0gZnJvbSBcImdhbWUvcm91dGVcIjtcbmltcG9ydCB7IENpdHkgfSBmcm9tIFwiZ2FtZS9jaXR5XCI7XG5cbmZ1bmN0aW9uIGdldFJhbmRvbUludChtYXgpIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbWF4KTtcbn1cblxuZXhwb3J0IGNsYXNzIEFpcnBsYW5lIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgYWN0aW9uOiBzdHJpbmc7XG4gICAgbGFzdEFjdGlvbjogbnVtYmVyO1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gICAgLy9waXhlbCBwcm8gc2Vjb25kXG4gICAgc3BlZWQ6IG51bWJlcjtcbiAgICBsYXN0VXBkYXRlOiBudW1iZXI7XG4gICAgdGFyZ2V0WDogbnVtYmVyO1xuICAgIHRhcmdldFk6IG51bWJlcjtcbiAgICBkb206IEhUTUxTcGFuRWxlbWVudDtcbiAgICB3b3JsZDogV29ybGQ7XG4gICAgcHJvZHVjdHM7XG4gICAgc3RhdHVzOiBzdHJpbmcgPSBcIlwiO1xuICAgIHJvdXRlOiBSb3V0ZVtdO1xuICAgIGFjdGl2ZVJvdXRlID0gMDtcbiAgICBjb25zdHJ1Y3Rvcih3b3JsZDogV29ybGQpIHtcbiAgICAgICAgdGhpcy53b3JsZCA9IHdvcmxkO1xuICAgICAgICB0aGlzLnJvdXRlID0gW107XG4gICAgICAgIC8qICBmb3IodmFyIHg9MDt4PDQ7eCsrKXtcbiAgICAgICAgICAgICAgdmFyIHJ0PW5ldyBSb3V0ZSgpO1xuICAgICAgICAgICAgICBydC5jaXR5aWQ9eDtcbiAgICAgICAgICAgICAgdGhpcy5yb3V0ZS5wdXNoKHJ0KTtcbiAgICAgICAgICB9Ki9cbiAgICB9XG4gICAgY3JlYXRlKCkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB0aGlzLmRvbSA9IDxhbnk+ZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKS5jcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQoXCI8c3BhbiBzdHlsZT0ndHJhbnNmb3JtOnJvdGF0ZSgwdHVybiknIGNsYXNzPSdtZGkgbWRpLWFpcnBsYW5lJz48L3NwYW4+XCIpLmNoaWxkcmVuWzBdOy8vZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuICAgICAgICB0aGlzLnggPSBnZXRSYW5kb21JbnQodGhpcy53b3JsZC5nYW1lLm1hcFdpZHRoKTtcbiAgICAgICAgdGhpcy55ID0gZ2V0UmFuZG9tSW50KHRoaXMud29ybGQuZ2FtZS5tYXBIZWlnaHQpO1xuICAgICAgICB0aGlzLmFjdGlvbiA9IFwid2FpdFwiO1xuICAgICAgICB0aGlzLnByb2R1Y3RzID0gW107XG4gICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgYWxsUHJvZHVjdHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIHRoaXMucHJvZHVjdHNbeF0gPSAwO1xuXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kb20uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgX3RoaXMub25jbGljayhldik7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuXG4gICAgfVxuXG4gICAgZmx5VG8oY2l0eTpDaXR5KSB7XG4gICAgICAgIHZhciB4PWNpdHkueDtcbiAgICAgICAgdmFyIHk9Y2l0eS55O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgICAgICBjb25zb2xlLmxvZyhcImZseSB0byBcIiArIGNpdHkubmFtZSlcbiAgICAgICAgdGhpcy5hY3Rpb24gPSBcImZseVwiO1xuICAgICAgICB0aGlzLnN0YXR1cz1cImZseSB0byBcIisgY2l0eS5uYW1lO1xuICAgICAgICB0aGlzLnRhcmdldFggPSB4O1xuICAgICAgICB0aGlzLnRhcmdldFkgPSB5O1xuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMud29ybGQuY2l0aWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgcG9zID0gdGhpcy53b3JsZC5jaXRpZXNbaV0uYWlycGxhbmVzSW5DaXR5LmluZGV4T2YodGhpcyk7XG4gICAgICAgICAgICBpZiAocG9zICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMud29ybGQuY2l0aWVzW2ldLmFpcnBsYW5lc0luQ2l0eS5zcGxpY2UocG9zLCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBzZWxlY3QoKSB7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmNvbG9yID0gXCJyZWRcIjtcbiAgICB9XG4gICAgdW5zZWxlY3QoKSB7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmNvbG9yID0gXCJibGFja1wiO1xuICAgIH1cbiAgICBhcnJpdmVkKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInRhcmdldCBhcnJpdmVkXCIpO1xuICAgICAgICB0aGlzLnRhcmdldFggPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMudGFyZ2V0WSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hY3Rpb24gPSBcIndhaXRcIjtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBcIlwiO1xuICAgICAgICB0aGlzLndvcmxkLmZpbmRDaXR5QXQodGhpcy54LCB0aGlzLnkpPy5haXJwbGFuZXNJbkNpdHkucHVzaCh0aGlzKTtcbiAgICAgICAgdGhpcy5kb20uc3R5bGUudHJhbnNmb3JtID0gXCJyb3RhdGUoMGRlZylcIjtcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlUm91dGUgIT09IC0xKSB7XG4gICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmxvYWQgbm93XCIpO1xuICAgICAgICAgICAgdGhpcy5hY3Rpb24gPSBcInVubG9hZFwiO1xuICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBcInVubG9hZFwiO1xuICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhbGNOZXdQb3NpdGlvbigpIHtcbiAgICAgICAgdmFyIHBpeGVsVG9UYXJnZXQgPSBNYXRoLnJvdW5kKE1hdGguc3FydChNYXRoLnBvdyh0aGlzLnRhcmdldFggLSB0aGlzLngsIDIpICsgTWF0aC5wb3codGhpcy50YXJnZXRZIC0gdGhpcy55LCAyKSkpOy8vUHl0aGFyb3Jhc1xuICAgICAgICB2YXIgZnJvbVggPSB0aGlzLng7XG4gICAgICAgIHZhciBmcm9tWSA9IHRoaXMueTtcbiAgICAgICAgdmFyIGZyb21UaW1lID0gMDtcbiAgICAgICAgdmFyIHRvWCA9IHRoaXMudGFyZ2V0WDtcbiAgICAgICAgdmFyIHRvWSA9IHRoaXMudGFyZ2V0WTtcbiAgICAgICAgdmFyIHRvVGltZSA9IHBpeGVsVG9UYXJnZXQgLyB0aGlzLnNwZWVkOyAgICAvL3Q9cy92OyBpbiBUYWdlXG4gICAgICAgIHZhciBzcGVlZFZlY3RvclggPSB0b1ggLSBmcm9tWDtcbiAgICAgICAgdmFyIHNwZWVkVmVjdG9yWSA9IHRvWSAtIGZyb21ZO1xuICAgICAgICB2YXIgc3BlZWRWZWN0b3JUaW1lID0gKHRvVGltZSAtIGZyb21UaW1lKTtcbiAgICAgICAgdmFyIG5vd1RpbWUgPSAodGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpIC0gdGhpcy5sYXN0VXBkYXRlKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICAgICAgdmFyIG5vd1ggPSBNYXRoLnJvdW5kKChub3dUaW1lIC8gc3BlZWRWZWN0b3JUaW1lKSAqIHNwZWVkVmVjdG9yWCArIGZyb21YKTtcbiAgICAgICAgdmFyIG5vd1kgPSBNYXRoLnJvdW5kKChub3dUaW1lIC8gc3BlZWRWZWN0b3JUaW1lKSAqIHNwZWVkVmVjdG9yWSArIGZyb21ZKTtcbiAgICAgICAgaWYgKG5vd1RpbWUgPj0gdG9UaW1lKSB7XG4gICAgICAgICAgICB0aGlzLnggPSB0aGlzLnRhcmdldFg7XG4gICAgICAgICAgICB0aGlzLnkgPSB0aGlzLnRhcmdldFk7XG4gICAgICAgICAgICB0aGlzLmFycml2ZWQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciByYWQgPSBNYXRoLmF0YW4oKGZyb21YIC0gdG9YKSAvIChmcm9tWSAtIHRvWSkpO1xuICAgICAgICAgICAgdmFyIHdpbmtlbCA9IDA7XG4gICAgICAgICAgICBpZiAoZnJvbVkgPiB0b1kpIHtcbiAgICAgICAgICAgICAgICB3aW5rZWwgPSAzNjAgLSByYWQgKiAoMTgwKSAvIE1hdGguUEk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHdpbmtlbCA9IDE4MCAtIHJhZCAqICgxODApIC8gTWF0aC5QSTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzID0gKFwiXCIgKyB3aW5rZWwpLnJlcGxhY2UoXCIsXCIsIFwiLlwiKTtcbiAgICAgICAgICAgIHRoaXMuZG9tLnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlKFwiICsgcyArIFwiZGVnKVwiO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2cocGl4ZWxUb1RhcmdldCtcIiBwaXhlbCBpbiBcIit0b1RpbWUrXCIgc2Vjb25kcy4gUG9zaXRpb24gXCIrbm93WCtcIiBcIitub3dZK1wiIGxhc3R1cGRhdGUgXCIrbm93VGltZStcIiBcIit3aW5rZWwrXCLCsFwiKTtcbiAgICAgICAgICAgIHRoaXMueCA9IG5vd1g7XG4gICAgICAgICAgICB0aGlzLnkgPSBub3dZO1xuICAgICAgICB9XG4gICAgfVxuICAgIHVwZGF0ZSgpIHtcblxuICAgICAgICBpZiAodGhpcy50YXJnZXRYICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FsY05ld1Bvc2l0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sYXN0VXBkYXRlID0gdGhpcy53b3JsZC5nYW1lLmRhdGUuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmRvbS5zdHlsZS50b3AgPSB0aGlzLnkgKyBcInB4XCI7XG4gICAgICAgIHRoaXMuZG9tLnN0eWxlLmxlZnQgPSAodGhpcy54IC0gMTUpICsgXCJweFwiO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVSb3V0ZSAhPT0gLTEmJnRoaXMucm91dGUubGVuZ3RoPjEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGlvbj09PVwidW5sb2FkXCImJih0aGlzLmxhc3RVcGRhdGUgLSB0aGlzLmxhc3RBY3Rpb24pID4gKDMgKiAxMDAwKjYwKjYwKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibG9hZCBub3dcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5hY3Rpb24gPSBcImxvYWRcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwibG9hZFwiO1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEFjdGlvbiA9IHRoaXMubGFzdFVwZGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGlvbj09PVwibG9hZFwiJiYodGhpcy5sYXN0VXBkYXRlIC0gdGhpcy5sYXN0QWN0aW9uKSA+ICgzICogMTAwMCo2MCo2MCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVJvdXRlKys7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5hY3RpdmVSb3V0ZT09PXRoaXMucm91dGUubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVJvdXRlPTA7XG4gICAgICAgICAgICAgICAgdmFyIGNpdHk9dGhpcy53b3JsZC5jaXRpZXNbdGhpcy5yb3V0ZVt0aGlzLmFjdGl2ZVJvdXRlXS5jaXR5aWRdO1xuICAgICAgICAgICAgICAgIHRoaXMuZmx5VG8oY2l0eSk7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0QWN0aW9uID0gdGhpcy5sYXN0VXBkYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIG9uY2xpY2sodGg6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgdGgucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGguc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSk7XG4gICAgICAgIHRoaXMud29ybGQuc2VsZWN0aW9uPy51bnNlbGVjdCgpO1xuICAgICAgICB0aGlzLndvcmxkLnNlbGVjdGlvbiA9IHRoaXM7XG4gICAgICAgIHRoaXMuc2VsZWN0KCk7XG4gICAgICAgIHZhciBoID0gQWlycGxhbmVEaWFsb2cuZ2V0SW5zdGFuY2UoKTtcbiAgICAgICAgaC5haXJwbGFuZSA9IHRoaXM7XG4gICAgICAgIGguc2hvdygpO1xuXG4gICAgfVxufVxuXG4vLzxzcGFuIHN0eWxlPSdmb250LXNpemU6MTAwcHg7Jz4mIzk5NTE7PC9zcGFuPiJdfQ==